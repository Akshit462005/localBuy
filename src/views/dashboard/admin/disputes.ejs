<!-- Dispute Management View -->
<div class="max-w-7xl mx-auto">
  <!-- Header with Filters -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
      <h2 class="text-2xl font-bold text-gray-800">Dispute Management</h2>

      <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 w-full md:w-auto">
        <select id="statusFilter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="">All Status</option>
          <option value="open">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
        </select>

        <select id="priorityFilter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="">All Priorities</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="urgent">Urgent</option>
        </select>

        <select id="typeFilter" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="">All Types</option>
          <option value="order_issue">Order Issue</option>
          <option value="product_quality">Product Quality</option>
          <option value="delivery">Delivery</option>
          <option value="payment">Payment</option>
          <option value="other">Other</option>
        </select>

        <div class="relative">
          <input type="text" 
                 id="searchInput"
                 placeholder="Search disputes..."
                 class="w-full md:w-64 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>
      </div>
    </div>
  </div>

  <!-- Disputes Table -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID/Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="disputesTableBody" class="bg-white divide-y divide-gray-200">
          <!-- Disputes will be dynamically inserted here -->
        </tbody>
      </table>

      <!-- Loading State -->
      <div id="loadingState" class="hidden">
        <div class="text-center py-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
          <p class="mt-2 text-sm text-gray-500">Loading disputes...</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-8">
        <p class="text-gray-500">No disputes found</p>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Showing <span id="pageStart">1</span> to <span id="pageEnd">10</span> of
            <span id="totalDisputes">0</span> disputes
          </p>
        </div>
        <div>
          <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button id="prevPage" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
              Previous
            </button>
            <button id="nextPage" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
              Next
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dispute Details Modal -->
<div id="disputeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
    <div id="disputeModalContent" class="max-h-[calc(100vh-200px)] overflow-y-auto">
      <!-- Modal content will be dynamically inserted here -->
    </div>
  </div>
</div>

<script>
// State management
let currentPage = 1;
let totalPages = 1;
const limit = 10;
let currentFilters = {
  status: '',
  priority: '',
  type: '',
  search: ''
};

// DOM Elements
const statusFilter = document.getElementById('statusFilter');
const priorityFilter = document.getElementById('priorityFilter');
const typeFilter = document.getElementById('typeFilter');
const searchInput = document.getElementById('searchInput');
const disputesTableBody = document.getElementById('disputesTableBody');
const loadingState = document.getElementById('loadingState');
const emptyState = document.getElementById('emptyState');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const pageStart = document.getElementById('pageStart');
const pageEnd = document.getElementById('pageEnd');
const totalDisputes = document.getElementById('totalDisputes');
const disputeModal = document.getElementById('disputeModal');
const disputeModalContent = document.getElementById('disputeModalContent');

// Fetch disputes
async function fetchDisputes() {
  try {
    loadingState.classList.remove('hidden');
    disputesTableBody.classList.add('hidden');
    emptyState.classList.add('hidden');

    const params = new URLSearchParams({
      page: currentPage,
      limit,
      ...currentFilters
    });

    const response = await fetch(`/api/disputes?${params}`);
    if (!response.ok) throw new Error('Failed to fetch disputes');

    const data = await response.json();
    renderDisputes(data);
  } catch (error) {
    console.error('Error fetching disputes:', error);
    alert('Failed to load disputes');
  } finally {
    loadingState.classList.add('hidden');
    disputesTableBody.classList.remove('hidden');
  }
}

function renderDisputes(data) {
  if (data.disputes.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }

  disputesTableBody.innerHTML = data.disputes.map(dispute => `
    <tr>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex flex-col">
          <div class="text-sm font-medium text-gray-900">#${dispute.id}</div>
          <div class="text-sm text-gray-500">${dispute.title}</div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getTypeColor(dispute.type)}">
          ${formatDisputeType(dispute.type)}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(dispute.status)}">
          ${formatStatus(dispute.status)}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getPriorityColor(dispute.priority)}">
          ${formatPriority(dispute.priority)}
        </span>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${dispute.customer_name}</div>
        <div class="text-sm text-gray-500">Order #${dispute.order_number}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${dispute.assigned_to_name || 'Unassigned'}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${new Date(dispute.created_at).toLocaleDateString()}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <button onclick="viewDisputeDetails('${dispute.id}')" class="text-blue-600 hover:text-blue-900">
          View Details
        </button>
      </td>
    </tr>
  `).join('');

  updatePagination(data.pagination);
}

async function viewDisputeDetails(disputeId) {
  try {
    const response = await fetch(`/api/disputes/${disputeId}`);
    if (!response.ok) throw new Error('Failed to fetch dispute details');

    const data = await response.json();
    renderDisputeModal(data);
    disputeModal.classList.remove('hidden');
  } catch (error) {
    console.error('Error fetching dispute details:', error);
    alert('Failed to load dispute details');
  }
}

function renderDisputeModal(data) {
  const { dispute, comments, attachments, history } = data;
  
  disputeModalContent.innerHTML = `
    <div class="flex justify-between items-start mb-6">
      <h3 class="text-lg font-bold text-gray-900">
        Dispute #${dispute.id}: ${dispute.title}
      </h3>
      <button onclick="closeDisputeModal()" class="text-gray-400 hover:text-gray-500">
        <span class="sr-only">Close</span>
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Main Info -->
      <div class="md:col-span-2 space-y-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-medium text-gray-900 mb-2">Description</h4>
          <p class="text-gray-700 whitespace-pre-wrap">${dispute.description}</p>
        </div>

        <!-- Comments Section -->
        <div>
          <h4 class="font-medium text-gray-900 mb-2">Comments</h4>
          <div class="space-y-4 mb-4">
            ${comments.map(comment => `
              <div class="bg-white p-4 rounded-lg border ${comment.is_internal ? 'border-yellow-200 bg-yellow-50' : ''}">
                <div class="flex justify-between mb-2">
                  <span class="font-medium text-gray-900">${comment.user_name}</span>
                  <span class="text-sm text-gray-500">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <p class="text-gray-700">${comment.comment}</p>
                ${comment.is_internal ? '<span class="text-xs text-yellow-600">(Internal Note)</span>' : ''}
              </div>
            `).join('')}
          </div>

          <!-- Add Comment Form -->
          <form onsubmit="addComment(event, '${dispute.id}')" class="space-y-4">
            <textarea
              id="newComment"
              class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              rows="3"
              placeholder="Add a comment..."
              required
            ></textarea>
            <div class="flex items-center space-x-4">
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                Add Comment
              </button>
              <label class="flex items-center text-sm text-gray-700">
                <input type="checkbox" id="isInternal" class="rounded border-gray-300 text-blue-600">
                <span class="ml-2">Internal Note</span>
              </label>
            </div>
          </form>
        </div>

        <!-- Attachments Section -->
        <div>
          <h4 class="font-medium text-gray-900 mb-2">Attachments</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            ${attachments.map(attachment => `
              <div class="flex items-center p-3 border rounded-lg">
                <svg class="h-6 w-6 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">${attachment.file_name}</p>
                  <p class="text-sm text-gray-500">By ${attachment.uploaded_by_name}</p>
                </div>
                <a href="/uploads/${attachment.file_path}" target="_blank" class="ml-4 text-blue-600 hover:text-blue-900">
                  View
                </a>
              </div>
            `).join('')}
          </div>

          <!-- Upload Form -->
          <form onsubmit="uploadAttachments(event, '${dispute.id}')" class="space-y-4">
            <div class="flex items-center justify-center w-full">
              <label class="flex flex-col w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:bg-gray-50">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <svg class="w-8 h-8 mb-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <p class="mb-2 text-sm text-gray-500">
                    <span class="font-semibold">Click to upload</span> or drag and drop
                  </p>
                  <p class="text-xs text-gray-500">
                    PNG, JPG, or PDF (max 5MB)
                  </p>
                </div>
                <input type="file" class="hidden" id="fileUpload" multiple accept=".png,.jpg,.jpeg,.pdf">
              </label>
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
              Upload Files
            </button>
          </form>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Status and Actions -->
        <div class="bg-white p-4 rounded-lg border">
          <h4 class="font-medium text-gray-900 mb-4">Status & Priority</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Status</label>
              <select
                onchange="updateDispute('${dispute.id}', 'status', this.value)"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="open" ${dispute.status === 'open' ? 'selected' : ''}>Open</option>
                <option value="in_progress" ${dispute.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                <option value="resolved" ${dispute.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                <option value="closed" ${dispute.status === 'closed' ? 'selected' : ''}>Closed</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Priority</label>
              <select
                onchange="updateDispute('${dispute.id}', 'priority', this.value)"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="low" ${dispute.priority === 'low' ? 'selected' : ''}>Low</option>
                <option value="medium" ${dispute.priority === 'medium' ? 'selected' : ''}>Medium</option>
                <option value="high" ${dispute.priority === 'high' ? 'selected' : ''}>High</option>
                <option value="urgent" ${dispute.priority === 'urgent' ? 'selected' : ''}>Urgent</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Assign To</label>
              <select
                onchange="updateDispute('${dispute.id}', 'assigned_to', this.value)"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              >
                <option value="">Unassigned</option>
                <!-- Admin users will be dynamically loaded here -->
              </select>
            </div>
          </div>
        </div>

        <!-- Order Details -->
        <div class="bg-white p-4 rounded-lg border">
          <h4 class="font-medium text-gray-900 mb-4">Order Details</h4>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Order Number</span>
              <span class="text-sm font-medium text-gray-900">#${dispute.order_number}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Amount</span>
              <span class="text-sm font-medium text-gray-900">â‚¹${dispute.order_amount}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Customer</span>
              <span class="text-sm font-medium text-gray-900">${dispute.customer_name}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-500">Shopkeeper</span>
              <span class="text-sm font-medium text-gray-900">${dispute.shopkeeper_name}</span>
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="bg-white p-4 rounded-lg border">
          <h4 class="font-medium text-gray-900 mb-4">History</h4>
          <div class="space-y-4">
            ${history.map(entry => `
              <div class="text-sm">
                <div class="flex justify-between mb-1">
                  <span class="font-medium text-gray-900">${entry.changed_by_name}</span>
                  <span class="text-gray-500">${new Date(entry.created_at).toLocaleString()}</span>
                </div>
                <p class="text-gray-700">
                  ${formatHistoryEntry(entry)}
                </p>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;

  // Load admin users for assignment
  loadAdminUsers();
}

async function loadAdminUsers() {
  try {
    const response = await fetch('/api/admin/users?role=admin');
    if (!response.ok) throw new Error('Failed to fetch admin users');

    const data = await response.json();
    const assignSelect = disputeModalContent.querySelector('select[onchange*="assigned_to"]');
    
    data.users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name;
      assignSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error loading admin users:', error);
  }
}

async function updateDispute(disputeId, field, value) {
  try {
    const response = await fetch(`/api/disputes/${disputeId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ [field]: value })
    });

    if (!response.ok) throw new Error('Failed to update dispute');

    // Refresh dispute details
    viewDisputeDetails(disputeId);
  } catch (error) {
    console.error('Error updating dispute:', error);
    alert('Failed to update dispute');
  }
}

async function addComment(event, disputeId) {
  event.preventDefault();
  
  const commentText = document.getElementById('newComment').value;
  const isInternal = document.getElementById('isInternal').checked;

  try {
    const response = await fetch(`/api/disputes/${disputeId}/comments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        comment: commentText,
        is_internal: isInternal
      })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    // Clear form and refresh dispute details
    document.getElementById('newComment').value = '';
    document.getElementById('isInternal').checked = false;
    viewDisputeDetails(disputeId);
  } catch (error) {
    console.error('Error adding comment:', error);
    alert('Failed to add comment');
  }
}

async function uploadAttachments(event, disputeId) {
  event.preventDefault();
  
  const fileInput = document.getElementById('fileUpload');
  const formData = new FormData();
  
  for (const file of fileInput.files) {
    formData.append('attachments', file);
  }

  try {
    const response = await fetch(`/api/disputes/${disputeId}/attachments`, {
      method: 'POST',
      body: formData
    });

    if (!response.ok) throw new Error('Failed to upload attachments');

    // Clear form and refresh dispute details
    fileInput.value = '';
    viewDisputeDetails(disputeId);
  } catch (error) {
    console.error('Error uploading attachments:', error);
    alert('Failed to upload attachments');
  }
}

function closeDisputeModal() {
  disputeModal.classList.add('hidden');
  fetchDisputes(); // Refresh the list to show any updates
}

// Utility functions
function formatDisputeType(type) {
  return type.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function formatStatus(status) {
  return status.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function formatPriority(priority) {
  return priority.charAt(0).toUpperCase() + priority.slice(1);
}

function getTypeColor(type) {
  const colors = {
    'order_issue': 'bg-orange-100 text-orange-800',
    'product_quality': 'bg-red-100 text-red-800',
    'delivery': 'bg-blue-100 text-blue-800',
    'payment': 'bg-green-100 text-green-800',
    'other': 'bg-gray-100 text-gray-800'
  };
  return colors[type] || 'bg-gray-100 text-gray-800';
}

function getStatusColor(status) {
  const colors = {
    'open': 'bg-yellow-100 text-yellow-800',
    'in_progress': 'bg-blue-100 text-blue-800',
    'resolved': 'bg-green-100 text-green-800',
    'closed': 'bg-gray-100 text-gray-800'
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
}

function getPriorityColor(priority) {
  const colors = {
    'low': 'bg-gray-100 text-gray-800',
    'medium': 'bg-blue-100 text-blue-800',
    'high': 'bg-orange-100 text-orange-800',
    'urgent': 'bg-red-100 text-red-800'
  };
  return colors[priority] || 'bg-gray-100 text-gray-800';
}

function formatHistoryEntry(entry) {
  let changes = [];
  
  if (entry.old_status !== entry.new_status) {
    changes.push(`Status changed from ${formatStatus(entry.old_status)} to ${formatStatus(entry.new_status)}`);
  }
  
  if (entry.old_priority !== entry.new_priority) {
    changes.push(`Priority changed from ${formatPriority(entry.old_priority)} to ${formatPriority(entry.new_priority)}`);
  }
  
  if (entry.old_assigned_to !== entry.new_assigned_to) {
    const oldAssigned = entry.old_assigned_name || 'Unassigned';
    const newAssigned = entry.new_assigned_name || 'Unassigned';
    changes.push(`Assignment changed from ${oldAssigned} to ${newAssigned}`);
  }
  
  return changes.join(', ');
}

// Event Listeners
statusFilter.addEventListener('change', () => {
  currentFilters.status = statusFilter.value;
  currentPage = 1;
  fetchDisputes();
});

priorityFilter.addEventListener('change', () => {
  currentFilters.priority = priorityFilter.value;
  currentPage = 1;
  fetchDisputes();
});

typeFilter.addEventListener('change', () => {
  currentFilters.type = typeFilter.value;
  currentPage = 1;
  fetchDisputes();
});

searchInput.addEventListener('input', debounce(() => {
  currentFilters.search = searchInput.value;
  currentPage = 1;
  fetchDisputes();
}, 300));

prevPageBtn.addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    fetchDisputes();
  }
});

nextPageBtn.addEventListener('click', () => {
  if (currentPage < totalPages) {
    currentPage++;
    fetchDisputes();
  }
});

// Close modal when clicking outside
disputeModal.addEventListener('click', (e) => {
  if (e.target === disputeModal) {
    closeDisputeModal();
  }
});

// Utility function for debouncing
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Initial load
fetchDisputes();
</script>