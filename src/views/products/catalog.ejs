<!-- Product Catalog -->
<div class="max-w-7xl mx-auto">
  <div class="flex flex-col md:flex-row gap-6">
    <!-- Filters Sidebar -->
    <div class="w-full md:w-64 bg-white shadow rounded-lg p-4 h-fit">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Filters</h3>
      <form id="filterForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select name="category" class="w-full rounded-md border-gray-300">
            <option value="">All Categories</option>
            <option value="clothing">Clothing</option>
            <option value="electronics">Electronics</option>
            <option value="food">Food & Beverages</option>
            <option value="home">Home & Living</option>
            <option value="beauty">Beauty & Health</option>
            <option value="books">Books & Stationery</option>
            <option value="sports">Sports & Fitness</option>
            <option value="toys">Toys & Games</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
          <select name="gender" class="w-full rounded-md border-gray-300">
            <option value="">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="unisex">Unisex</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Age Range</label>
          <select name="age_range" class="w-full rounded-md border-gray-300">
            <option value="">All Ages</option>
            <option value="kids">Kids</option>
            <option value="teens">Teens</option>
            <option value="adults">Adults</option>
            <option value="seniors">Seniors</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price Range</label>
          <div class="grid grid-cols-2 gap-2">
            <input type="number" name="minPrice" placeholder="Min" class="w-full rounded-md border-gray-300">
            <input type="number" name="maxPrice" placeholder="Max" class="w-full rounded-md border-gray-300">
          </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
          Apply Filters
        </button>
      </form>
    </div>

    <!-- Product Grid -->
    <div class="flex-1">
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Products</h2>
          <div class="flex items-center space-x-4">
            <select id="sort" class="rounded-md border-gray-300">
              <option value="newest">Newest First</option>
              <option value="price_low">Price: Low to High</option>
              <option value="price_high">Price: High to Low</option>
            </select>
          </div>
        </div>

        <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <!-- Products will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Product Card Template -->
<template id="productTemplate">
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="aspect-w-1 aspect-h-1 bg-gray-200">
      <!-- Replace with actual product image -->
      <div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500">
        Product Image
      </div>
    </div>
    <div class="p-4">
      <h3 class="text-lg font-medium text-gray-900 product-name"></h3>
      <p class="mt-1 text-sm text-gray-500 product-shopkeeper"></p>
      <p class="mt-1 text-sm text-gray-500 product-category"></p>
      <div class="mt-2 flex items-center justify-between">
        <p class="text-lg font-bold text-gray-900 product-price"></p>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium product-stock"></span>
      </div>
      <div class="mt-4 flex space-x-2">
        <button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 add-to-cart">
          Add to Cart
        </button>
        <a href="#" class="view-details flex items-center justify-center px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
          Details
        </a>
      </div>
    </div>
  </div>
</template>

<script>
  const productGrid = document.getElementById('productGrid');
  const productTemplate = document.getElementById('productTemplate');
  const filterForm = document.getElementById('filterForm');
  const sortSelect = document.getElementById('sort');

  let products = [];

  async function fetchProducts(filters = {}) {
    try {
      const queryParams = new URLSearchParams(filters);
      const response = await fetch(`/api/products?${queryParams}`);
      products = await response.json();
      renderProducts();
    } catch (error) {
      console.error('Error fetching products:', error);
      alert('Failed to load products');
    }
  }

  function renderProducts() {
    productGrid.innerHTML = '';
    products.forEach(product => {
      const template = productTemplate.content.cloneNode(true);
      
      template.querySelector('.product-name').textContent = product.name;
      template.querySelector('.product-shopkeeper').textContent = `Sold by: ${product.shopkeeper_name}`;
      template.querySelector('.product-category').textContent = `${product.category} · ${product.gender || 'Unisex'} · ${product.age_range || 'All Ages'}`;
      template.querySelector('.product-price').textContent = `₹${product.price}`;
      
      const stockBadge = template.querySelector('.product-stock');
      if (product.stock > 10) {
        stockBadge.textContent = 'In Stock';
        stockBadge.classList.add('bg-green-100', 'text-green-800');
      } else if (product.stock > 0) {
        stockBadge.textContent = 'Low Stock';
        stockBadge.classList.add('bg-yellow-100', 'text-yellow-800');
      } else {
        stockBadge.textContent = 'Out of Stock';
        stockBadge.classList.add('bg-red-100', 'text-red-800');
      }

      const addToCartBtn = template.querySelector('.add-to-cart');
      addToCartBtn.disabled = product.stock === 0;
      if (product.stock === 0) {
        addToCartBtn.classList.replace('bg-blue-600', 'bg-gray-400');
        addToCartBtn.classList.replace('hover:bg-blue-700', 'cursor-not-allowed');
      }

      const detailsLink = template.querySelector('.view-details');
      detailsLink.href = `/products/${product.id}`;

      addToCartBtn.addEventListener('click', () => addToCart(product.id));
      
      productGrid.appendChild(template);
    });
  }

  async function addToCart(productId) {
    try {
      const response = await fetch('/api/cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId, quantity: 1 })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message);
      }

      alert('Product added to cart');
    } catch (error) {
      console.error('Error adding to cart:', error);
      if (error.message === 'Authentication required') {
        window.location.href = '/login';
      } else {
        alert(error.message || 'Failed to add product to cart');
      }
    }
  }

  filterForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const filters = Object.fromEntries(formData.entries());
    // Remove empty filters
    Object.keys(filters).forEach(key => {
      if (!filters[key]) delete filters[key];
    });
    fetchProducts(filters);
  });

  sortSelect.addEventListener('change', () => {
    const sortBy = sortSelect.value;
    if (sortBy === 'price_low') {
      products.sort((a, b) => a.price - b.price);
    } else if (sortBy === 'price_high') {
      products.sort((a, b) => b.price - a.price);
    } else {
      products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }
    renderProducts();
  });

  // Initial load
  fetchProducts();
</script>