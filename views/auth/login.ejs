<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - LocalBuy</title>
    <link rel="stylesheet" href="/css/style.css">
    <meta name="description" content="Login to your LocalBuy account to start shopping from local stores">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <h2>Welcome Back</h2>
            <% if (locals.error) { %>
                <div class="error"><%= error %></div>
            <% } %>
            <form action="/auth/login" method="POST" id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="Enter your email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn primary" id="loginBtn">
                    Sign In
                </button>
            </form>
            <p class="auth-link">New to LocalBuy? <a href="/auth/register">Create an account</a></p>
        </div>
    </div>

    <!-- Cache System Scripts -->
    <script src="/js/cache.js"></script>
    <script src="/js/cart-manager.js"></script>
    <script src="/js/session-manager.js"></script>

    <script>
        // Initialize cache system
        window.cache = new BrowserCache();
        window.cartManager = new CartManager();
        window.userSessionManager = new UserSessionManager();

        // Add auto-save attribute to form
        document.getElementById('loginForm').setAttribute('data-autosave', 'login-form');

        // Add loading state to button on form submit
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            const btn = document.getElementById('loginBtn');
            btn.classList.add('loading');
            btn.disabled = true;
            
            // Clear saved form data on successful login
            window.userSessionManager.clearFormData('login-form');
        });
        
        // Add focus animations
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            input.addEventListener('blur', function() {
                if (!this.value) {
                    this.parentElement.classList.remove('focused');
                }
            });
        });

        // Apply saved theme
        window.userSessionManager.applyTheme();
        
        // Auto-restore form data
        document.addEventListener('DOMContentLoaded', function() {
            const savedData = window.userSessionManager.restoreFormData('login-form');
            if (savedData && savedData.email) {
                document.getElementById('email').value = savedData.email;
                document.getElementById('email').parentElement.classList.add('focused');
            }
        });

        // Auto-save form data as user types
        document.querySelectorAll('#loginForm input').forEach(input => {
            if (input.type !== 'password') { // Don't save passwords
                input.addEventListener('input', debounce(() => {
                    const formData = {
                        email: document.getElementById('email').value
                    };
                    window.userSessionManager.saveFormData('login-form', formData);
                }, 1000));
            }
        });

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        console.log('âœ… Login page with caching initialized');
    </script>
</body>
</html>