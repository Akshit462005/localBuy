<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - LocalBuy</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/cache.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-store"></i>
                LocalBuy
            </div>
            <div class="nav-links">
                <a href="/user/cart" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="cart-badge" id="cart-badge">0</span>
                </a>
                <a href="/user/orders" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
                <a href="/auth/logout" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="dashboard-header">
            <div class="welcome-section">
                <h1><i class="fas fa-home"></i> Welcome to Your Dashboard</h1>
                <p class="dashboard-subtitle">Discover amazing products from local shopkeepers</p>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-box-open"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalProducts"><%= products.length %></span>
                        <span class="stat-label">Available Products</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-store"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalShops">0</span>
                        <span class="stat-label">Active Shops</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-heart"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="wishlistCount">0</span>
                        <span class="stat-label">Wishlist Items</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recently Viewed Section -->
        <div class="recently-viewed-section" id="recentlyViewedSection" style="display: none;">
            <h3><i class="fas fa-history"></i> Recently Viewed</h3>
            <div class="recently-viewed-grid" id="recentlyViewedGrid">
                <!-- Dynamic content -->
            </div>
        </div>

        <div class="controls-section">
            <div class="search-filter-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="search" id="searchInput" placeholder="Search products, shops, or descriptions..." data-autosave="dashboard-search">
                    <button id="clearSearch" class="clear-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-controls">
                    <select id="sortBy" class="filter-select" data-autosave="dashboard-sort">
                        <option value="name">Sort by Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="shop">Shop Name</option>
                        <option value="recent">Recently Added</option>
                    </select>
                    
                    <div class="price-filter">
                        <label for="priceRange">Max Price: ₹<span id="priceValue">1000</span></label>
                        <input type="range" id="priceRange" min="0" max="1000" value="1000" data-autosave="dashboard-price">
                    </div>
                    
                    <button id="resetFilters" class="btn secondary">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            
            <div class="view-controls">
                <div class="view-toggle">
                    <button id="gridView" class="view-btn active">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button id="listView" class="view-btn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                
                <div class="theme-toggle">
                    <button id="themeToggle" class="btn secondary">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="products-section">
            <div class="section-header">
                <h2>Available Products</h2>
                <span class="product-count">Showing <span id="visibleCount"><%= products.length %></span> of <span id="totalCount"><%= products.length %></span> products</span>
            </div>
            
            <div class="product-grid" id="productGrid">
                <% products.forEach((product, index) => { %>
                    <div class="product-card" 
                         data-product-id="<%= product.id %>"
                         data-product='<%= JSON.stringify(product) %>' 
                         data-index="<%= index %>">
                        <div class="product-image">
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" loading="lazy">
                            <% } else { %>
                                <div class="no-image">
                                    <i class="fas fa-image"></i>
                                    <span>No Image</span>
                                </div>
                            <% } %>
                            <div class="product-overlay">
                                <button class="product-quick-view" data-product-id="<%= product.id %>" onclick="openQuickView(<%= index %>)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="wishlist-btn" data-product-id="<%= product.id %>" onclick="toggleWishlist(<%= product.id %>)">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="product-info">
                            <div class="product-header">
                                <h3 class="product-name"><%= product.name %></h3>
                                <div class="product-rating">
                                    <% for(let i = 0; i < 5; i++) { %>
                                        <i class="fas fa-star"></i>
                                    <% } %>
                                    <span class="rating-text">(4.8)</span>
                                </div>
                            </div>
                            
                            <p class="product-description"><%= product.description %></p>
                            
                            <div class="product-meta">
                                <p class="product-price">
                                    <span class="currency">₹</span>
                                    <span class="amount"><%= product.price %></span>
                                </p>
                                <p class="shop-name">
                                    <i class="fas fa-store-alt"></i>
                                    <%= product.shopkeeper_name %>
                                </p>
                            </div>
                            
                            <div class="product-actions">
                                <button class="btn primary add-to-cart" data-product-id="<%= product.id %>" onclick="addToCart(<%= product.id %>, this)">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Add to Cart</span>
                                </button>
                                <button class="btn secondary quick-buy-btn" onclick="quickBuy(<%= product.id %>)">
                                    <i class="fas fa-bolt"></i>
                                    Quick Buy
                                </button>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div id="noResults" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <h3>No products found</h3>
                <p>Try adjusting your search criteria or filters</p>
            </div>
        </div>
    </main>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeQuickView()">
                <i class="fas fa-times"></i>
            </button>
            <div id="quickViewContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>LocalBuy</h4>
                <p>Connecting local businesses with customers</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="/user/dashboard">Dashboard</a>
                <a href="/user/cart">Cart</a>
                <a href="/user/orders">Orders</a>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Contact Us</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 LocalBuy. All rights reserved.</p>
        </div>
    </footer>

    <!-- Session Storage Cache Scripts -->
    <script src="/js/cache.js"></script>
    <script src="/js/cart-manager.js"></script>
    <script src="/js/session-manager.js"></script>
    
    <!-- Local Storage Cache Scripts -->
    <script src="/js/local-cache.js"></script>
    <script src="/js/persistent-cart.js"></script>
    <script src="/js/persistent-preferences.js"></script>
    
    <!-- Cache Integration -->
    <script src="/js/cache-integration.js"></script>

    <script>
        // Initialize Session Storage cache system
        window.cache = new BrowserCache();
        window.cartManager = new CartManager();
        window.userSessionManager = new UserSessionManager();
        
        // Initialize Local Storage cache system
        window.localCache = new LocalStorageCache();
        window.persistentCart = new PersistentCartManager(window.localCache);
        window.persistentPreferences = new PersistentPreferencesManager(window.localCache);
        
        // Apply persistent theme
        window.persistentPreferences.applyTheme();
        
        // Initialize dual cache system
        if (typeof initializeCacheSystems === 'function') {
            initializeCacheSystems();
        }
        
        // Initialize dual cache system
        if (typeof initializeCacheSystems === 'function') {
            initializeCacheSystems();
        }
        
        console.log('✅ LocalBuy Dual Cache System Ready (Session + Local Storage)');

        // Global variables
        let allProducts = [];
        let filteredProducts = [];
        let isGridView = true;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            loadRecentlyViewed();
            updateWishlistDisplay();
            restoreUserPreferences();
            hideLoadingOverlay();
            
            console.log('✅ Dashboard with caching initialized');
        });

        function initializeDashboard() {
            // Extract product data
            const productCards = document.querySelectorAll('.product-card');
            allProducts = Array.from(productCards).map(card => {
                return JSON.parse(card.getAttribute('data-product'));
            });
            filteredProducts = [...allProducts];
            
            // Update stats
            updateStats();
            
            // Set price range max
            const maxPrice = Math.max(...allProducts.map(p => parseFloat(p.price)));
            const priceRange = document.getElementById('priceRange');
            priceRange.max = maxPrice;
            document.getElementById('priceValue').textContent = maxPrice;
        }

        function setupEventListeners() {
            // Search functionality with caching
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(performSearch, 300));
            
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            // Filters with preference saving
            document.getElementById('sortBy').addEventListener('change', () => {
                window.userSessionManager.savePreference('sortBy', document.getElementById('sortBy').value);
                applyFilters();
            });
            
            document.getElementById('priceRange').addEventListener('input', () => {
                updatePriceFilter();
                window.userSessionManager.savePreference('priceRange', document.getElementById('priceRange').value);
            });
            
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            // View toggle with preference saving
            document.getElementById('gridView').addEventListener('click', () => setViewMode('grid'));
            document.getElementById('listView').addEventListener('click', () => setViewMode('list'));
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // Cache search query
            if (query) {
                const searches = window.cache.get('search_history') || [];
                if (!searches.includes(query)) {
                    searches.unshift(query);
                    if (searches.length > 10) searches.pop();
                    window.cache.set('search_history', searches, 7 * 24 * 60); // 7 days
                }
            }
            
            if (query === '') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => {
                    return product.name.toLowerCase().includes(query) ||
                           product.description.toLowerCase().includes(query) ||
                           product.shopkeeper_name.toLowerCase().includes(query);
                });
            }
            
            applyFilters();
        }

        function applyFilters() {
            const sortBy = document.getElementById('sortBy').value;
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            
            // Filter by price
            let filtered = filteredProducts.filter(product => parseFloat(product.price) <= maxPrice);
            
            // Sort products
            switch(sortBy) {
                case 'name':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-low':
                    filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                    break;
                case 'price-high':
                    filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                    break;
                case 'shop':
                    filtered.sort((a, b) => a.shopkeeper_name.localeCompare(b.shopkeeper_name));
                    break;
                case 'recent':
                    // Sort by recently viewed/added (use cached data)
                    const recentlyViewed = window.cache.get('recently_viewed') || [];
                    filtered.sort((a, b) => {
                        const aIndex = recentlyViewed.indexOf(a.id.toString());
                        const bIndex = recentlyViewed.indexOf(b.id.toString());
                        return (aIndex !== -1 ? aIndex : 999) - (bIndex !== -1 ? bIndex : 999);
                    });
                    break;
            }
            
            displayProducts(filtered);
        }

        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');
            
            if (products.length === 0) {
                productGrid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                productGrid.style.display = isGridView ? 'grid' : 'block';
                noResults.style.display = 'none';
                
                // Hide all cards first
                const allCards = document.querySelectorAll('.product-card');
                allCards.forEach(card => card.style.display = 'none');
                
                // Show matching cards
                products.forEach(product => {
                    const card = document.querySelector(`[data-product*='"id":${product.id}']`);
                    if (card) {
                        card.style.display = 'block';
                        card.style.animation = 'fadeInUp 0.3s ease-out';
                    }
                });
            }
            
            // Update counts
            document.getElementById('visibleCount').textContent = products.length;
            document.getElementById('totalCount').textContent = allProducts.length;
        }

        function addToCart(productId, buttonEl) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const cartItem = {
                id: product.id,
                name: product.name,
                price: product.price,
                image: product.image_url,
                quantity: 1
            };

            // Add to both Session Storage cart (temporary) and Local Storage cart (persistent)
            window.cartManager.addItem(cartItem);
            
            // Also add to persistent cart if available
            if (window.persistentCart) {
                window.persistentCart.addItem(cartItem);
                console.log('✅ Added to both session and persistent carts');
            }

            const originalText = buttonEl.innerHTML;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            buttonEl.disabled = true;
            
            // Simulate API call (replace with actual server call)
            setTimeout(() => {
                buttonEl.innerHTML = '<i class="fas fa-check"></i> Added!';
                buttonEl.classList.add('success');
                
                setTimeout(() => {
                    buttonEl.innerHTML = originalText;
                    buttonEl.classList.remove('success');
                    buttonEl.disabled = false;
                }, 2000);
            }, 500);
        }

        function toggleWishlist(productId) {
            const wishlist = window.cache.get('wishlist') || [];
            const index = wishlist.indexOf(productId);
            
            if (index > -1) {
                wishlist.splice(index, 1);
                window.userSessionManager.showNotification('Removed from wishlist', 'info');
            } else {
                wishlist.push(productId);
                window.userSessionManager.showNotification('Added to wishlist', 'success');
            }
            
            window.cache.set('wishlist', wishlist, 30 * 24 * 60); // 30 days
            updateWishlistDisplay();
        }

        function updateWishlistDisplay() {
            const wishlist = window.cache.get('wishlist') || [];
            document.getElementById('wishlistCount').textContent = wishlist.length;
            
            // Update wishlist button states
            const wishlistBtns = document.querySelectorAll('.wishlist-btn');
            wishlistBtns.forEach(btn => {
                const productId = parseInt(btn.getAttribute('data-product-id'));
                const icon = btn.querySelector('i');
                
                if (wishlist.includes(productId)) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.classList.add('active');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.classList.remove('active');
                }
            });
        }

        function loadRecentlyViewed() {
            const recentlyViewed = window.cache.get('recently_viewed') || [];
            if (recentlyViewed.length === 0) return;

            const section = document.getElementById('recentlyViewedSection');
            const grid = document.getElementById('recentlyViewedGrid');
            
            let html = '';
            recentlyViewed.slice(0, 5).forEach(productId => {
                const product = allProducts.find(p => p.id.toString() === productId);
                if (product) {
                    html += `
                        <div class="recent-product-card" data-product-id="${product.id}">
                            <div class="recent-product-image">
                                ${product.image_url ? 
                                    `<img src="${product.image_url}" alt="${product.name}">` : 
                                    '<div class="no-image"><i class="fas fa-image"></i></div>'
                                }
                            </div>
                            <h4>${product.name}</h4>
                            <p class="price">₹${product.price}</p>
                            <button class="btn small primary" onclick="addToCart(${product.id}, this)">
                                Add to Cart
                            </button>
                        </div>
                    `;
                }
            });
            
            if (html) {
                grid.innerHTML = html;
                section.style.display = 'block';
            }
        }

        function restoreUserPreferences() {
            // Restore filter preferences
            const sortBy = window.userSessionManager.getPreference('sortBy');
            if (sortBy) {
                document.getElementById('sortBy').value = sortBy;
            }
            
            const priceRange = window.userSessionManager.getPreference('priceRange');
            if (priceRange) {
                document.getElementById('priceRange').value = priceRange;
                document.getElementById('priceValue').textContent = priceRange;
            }
            
            const viewMode = window.userSessionManager.getPreference('viewMode') || 'grid';
            setViewMode(viewMode);
            
            // Apply saved filters
            applyFilters();
        }

        function setViewMode(mode) {
            isGridView = mode === 'grid';
            const productGrid = document.getElementById('productGrid');
            
            document.getElementById('gridView').classList.toggle('active', isGridView);
            document.getElementById('listView').classList.toggle('active', !isGridView);
            
            if (isGridView) {
                productGrid.classList.remove('list-view');
                productGrid.classList.add('grid-view');
            } else {
                productGrid.classList.remove('grid-view');
                productGrid.classList.add('list-view');
            }
            
            // Save preference
            window.userSessionManager.savePreference('viewMode', mode);
        }

        function toggleTheme() {
            const currentTheme = window.userSessionManager.getPreference('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            window.userSessionManager.setTheme(newTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function updatePriceFilter() {
            const priceRange = document.getElementById('priceRange');
            const priceValue = document.getElementById('priceValue');
            priceValue.textContent = priceRange.value;
            
            debounce(applyFilters, 150)();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'name';
            
            const priceRange = document.getElementById('priceRange');
            priceRange.value = priceRange.max;
            document.getElementById('priceValue').textContent = priceRange.max;
            
            // Clear saved preferences
            window.userSessionManager.clearPreference('sortBy');
            window.userSessionManager.clearPreference('priceRange');
            
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function openQuickView(index) {
            const product = allProducts[index];
            
            // Track in recently viewed
            const recentlyViewed = window.cache.get('recently_viewed') || [];
            const productIdStr = product.id.toString();
            
            // Remove if already exists
            const existingIndex = recentlyViewed.indexOf(productIdStr);
            if (existingIndex > -1) {
                recentlyViewed.splice(existingIndex, 1);
            }
            
            // Add to beginning
            recentlyViewed.unshift(productIdStr);
            
            // Keep only last 10
            if (recentlyViewed.length > 10) {
                recentlyViewed.pop();
            }
            
            window.cache.set('recently_viewed', recentlyViewed, 24 * 60); // 24 hours
            
            // Show modal
            const modal = document.getElementById('quickViewModal');
            const content = document.getElementById('quickViewContent');
            
            content.innerHTML = `
                <div class="quick-view-product">
                    <div class="quick-view-image">
                        ${product.image_url ? 
                            `<img src="${product.image_url}" alt="${product.name}">` : 
                            `<div class="no-image"><i class="fas fa-image"></i><span>No Image</span></div>`
                        }
                    </div>
                    <div class="quick-view-info">
                        <h2>${product.name}</h2>
                        <div class="product-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span>(4.8 stars)</span>
                        </div>
                        <p class="description">${product.description}</p>
                        <div class="price-section">
                            <span class="price">₹${product.price}</span>
                        </div>
                        <div class="shop-info">
                            <i class="fas fa-store-alt"></i>
                            <span>Sold by: ${product.shopkeeper_name}</span>
                        </div>
                        <div class="quick-view-actions">
                            <button class="btn primary" onclick="addToCart(${product.id}, this); closeQuickView();">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                            <button class="btn secondary" onclick="quickBuy(${product.id})">
                                <i class="fas fa-bolt"></i> Quick Buy
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeQuickView() {
            document.getElementById('quickViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function quickBuy(productId) {
            addToCart(productId, document.createElement('button'));
            setTimeout(() => {
                window.location.href = '/user/cart';
            }, 1000);
        }

        function updateStats() {
            const uniqueShops = new Set(allProducts.map(p => p.shopkeeper_name)).size;
            document.getElementById('totalShops').textContent = uniqueShops;
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Escape to close modal
            if (e.key === 'Escape') {
                closeQuickView();
            }
        }

        function hideLoadingOverlay() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
        }

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>