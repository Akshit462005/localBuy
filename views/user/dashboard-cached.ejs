<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - LocalBuy</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/cache.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Wishlist Section Styles */
        .wishlist-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .wishlist-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wishlist-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .wishlist-item {
            position: relative;
        }
        
        .remove-from-wishlist {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 2;
        }
        
        .remove-from-wishlist:hover {
            background: rgba(220, 53, 69, 1);
        }
        
        .wishlist-btn.in-wishlist {
            background: #dc3545 !important;
            color: white !important;
        }
        
        .wishlist-btn.in-wishlist i {
            color: white !important;
        }
        
        .added-date {
            font-size: 0.8em;
            color: #666;
            margin: 5px 0;
        }
        
        /* Wishlist Navigation Styles */
        .wishlist-badge {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
            min-width: 18px;
            text-align: center;
            display: inline-block;
        }
        
        .wishlist-nav.active {
            background: #dc3545;
            color: white;
        }
        
        /* Wishlist Panel */
        .wishlist-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .wishlist-panel.open {
            right: 0;
        }
        
        .wishlist-panel-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .wishlist-panel-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .wishlist-panel-content {
            padding: 20px;
        }
        
        .wishlist-panel-item {
            display: flex;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .wishlist-panel-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .wishlist-panel-item-info {
            flex: 1;
        }
        
        .wishlist-panel-item-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .wishlist-panel-item-price {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .wishlist-panel-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .wishlist-panel-item-actions button {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .wishlist-panel-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .wishlist-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .wishlist-overlay.open {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-store"></i>
                LocalBuy
            </div>
            <div class="nav-links">
                <a href="/user/cart" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="cart-badge" id="cart-badge">0</span>
                </a>
                <a href="#" class="nav-link wishlist-nav" onclick="toggleWishlistPanel(event)">
                    <i class="fas fa-heart"></i>
                    <span>Wishlist</span>
                    <span class="wishlist-badge" id="wishlist-nav-badge">0</span>
                </a>
                <a href="/user/orders" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
                <a href="/auth/logout" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="dashboard-header">
            <div class="welcome-section">
                <h1><i class="fas fa-home"></i> Welcome to Your Dashboard</h1>
                <p class="dashboard-subtitle">Discover amazing products from local shopkeepers</p>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-box-open"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalProducts"><%= products.length %></span>
                        <span class="stat-label">Available Products</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-store"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalShops">0</span>
                        <span class="stat-label">Active Shops</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-heart"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="wishlistCount">0</span>
                        <span class="stat-label">Wishlist Items</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recently Viewed Section -->
        <div class="recently-viewed-section" id="recentlyViewedSection" style="display: none;">
            <h3><i class="fas fa-history"></i> Recently Viewed</h3>
            <div class="recently-viewed-grid" id="recentlyViewedGrid">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Wishlist Section -->
        <div class="wishlist-section" id="wishlistSection" style="display: none;">
            <h3><i class="fas fa-heart"></i> My Wishlist <span class="wishlist-count" id="wishlistCount">0</span></h3>
            <div class="wishlist-grid" id="wishlistGrid">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Wishlist Section -->
        <div class="wishlist-section" id="wishlistSection" style="display: none;">
            <h3><i class="fas fa-heart"></i> My Wishlist <span class="wishlist-count" id="wishlistCount">0</span></h3>
            <div class="wishlist-grid" id="wishlistGrid">
                <!-- Dynamic content -->
            </div>
        </div>

        <div class="controls-section">
            <div class="search-filter-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="search" id="searchInput" placeholder="Search products, shops, or descriptions..." data-autosave="dashboard-search">
                    <button id="clearSearch" class="clear-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-controls">
                    <select id="sortBy" class="filter-select" data-autosave="dashboard-sort">
                        <option value="name">Sort by Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="shop">Shop Name</option>
                        <option value="recent">Recently Added</option>
                    </select>
                    
                    <div class="price-filter">
                        <label for="priceRange">Max Price: ₹<span id="priceValue">1000</span></label>
                        <input type="range" id="priceRange" min="0" max="1000" value="1000" data-autosave="dashboard-price">
                    </div>
                    
                    <button id="resetFilters" class="btn secondary">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            
            <div class="view-controls">
                <div class="view-toggle">
                    <button id="gridView" class="view-btn active">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button id="listView" class="view-btn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                
                <div class="theme-toggle">
                    <button id="themeToggle" class="btn secondary">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="products-section">
            <div class="section-header">
                <h2>Available Products</h2>
                <span class="product-count">Showing <span id="visibleCount"><%= products.length %></span> of <span id="totalCount"><%= products.length %></span> products</span>
            </div>
            
            <div class="product-grid" id="productGrid">
                <% products.forEach((product, index) => { %>
                    <div class="product-card" 
                         data-product-id="<%= product.id %>"
                         data-product='<%= JSON.stringify(product) %>' 
                         data-index="<%= index %>">
                        <div class="product-image">
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" loading="lazy">
                            <% } else { %>
                                <div class="no-image">
                                    <i class="fas fa-image"></i>
                                    <span>No Image</span>
                                </div>
                            <% } %>
                            <div class="product-overlay">
                                <button class="product-quick-view" data-product-id="<%= product.id %>" onclick="openQuickView(<%= index %>)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="wishlist-btn" data-product-id="<%= product.id %>" onclick="toggleWishlist(<%= product.id %>)">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="product-info">
                            <div class="product-header">
                                <h3 class="product-name"><%= product.name %></h3>
                                <div class="product-rating">
                                    <% for(let i = 0; i < 5; i++) { %>
                                        <i class="fas fa-star"></i>
                                    <% } %>
                                    <span class="rating-text">(4.8)</span>
                                </div>
                            </div>
                            
                            <p class="product-description"><%= product.description %></p>
                            
                            <div class="product-meta">
                                <p class="product-price">
                                    <span class="currency">₹</span>
                                    <span class="amount"><%= product.price %></span>
                                </p>
                                <p class="shop-name">
                                    <i class="fas fa-store-alt"></i>
                                    <%= product.shopkeeper_name %>
                                </p>
                            </div>
                            
                            <div class="product-actions">
                                <button class="btn primary add-to-cart" data-product-id="<%= product.id %>" onclick="addToCart(<%= product.id %>, this)">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Add to Cart</span>
                                </button>
                                <button class="btn secondary wishlist-btn" onclick="toggleWishlist(<%= product.id %>, this)" data-product-id="<%= product.id %>">
                                    <i class="far fa-heart"></i>
                                    <span class="wishlist-text">Save</span>
                                </button>
                                <button class="btn secondary quick-buy-btn" onclick="quickBuy(<%= product.id %>)">
                                    <i class="fas fa-bolt"></i>
                                    Quick Buy
                                </button>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div id="noResults" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <h3>No products found</h3>
                <p>Try adjusting your search criteria or filters</p>
            </div>
        </div>
    </main>

    <!-- Wishlist Panel -->
    <div class="wishlist-overlay" id="wishlistOverlay" onclick="closeWishlistPanel()"></div>
    <div class="wishlist-panel" id="wishlistPanel">
        <div class="wishlist-panel-header">
            <h3><i class="fas fa-heart"></i> My Wishlist</h3>
            <button class="wishlist-panel-close" onclick="closeWishlistPanel()">×</button>
        </div>
        <div class="wishlist-panel-content" id="wishlistPanelContent">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeQuickView()">
                <i class="fas fa-times"></i>
            </button>
            <div id="quickViewContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>LocalBuy</h4>
                <p>Connecting local businesses with customers</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="/user/dashboard">Dashboard</a>
                <a href="/user/cart">Cart</a>
                <a href="/user/orders">Orders</a>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Contact Us</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 LocalBuy. All rights reserved.</p>
        </div>
    </footer>

    <!-- Session Storage Cache Scripts -->
    <script src="/js/cache.js"></script>
    <script src="/js/cart-manager.js"></script>
    <script src="/js/session-manager.js"></script>
    
    <!-- Local Storage Cache Scripts -->
    <script src="/js/local-cache.js"></script>
    <script src="/js/persistent-cart.js"></script>
    <script src="/js/persistent-preferences.js"></script>
    
    <!-- Cache Integration -->
    <script src="/js/cache-integration.js"></script>

    <script>
        // Initialize Session Storage cache system
        window.cache = new BrowserCache();
        window.cartManager = new CartManager();
        window.userSessionManager = new UserSessionManager();
        
        // Initialize Local Storage cache system
        window.localCache = new LocalStorageCache();
        window.persistentCart = new PersistentCartManager(window.localCache);
        window.persistentPreferences = new PersistentPreferencesManager(window.localCache);
        
        // Apply persistent theme
        window.persistentPreferences.applyTheme();
        
        // Initialize dual cache system
        if (typeof initializeCacheSystems === 'function') {
            initializeCacheSystems();
        }
        
        // Initialize dual cache system
        if (typeof initializeCacheSystems === 'function') {
            initializeCacheSystems();
        }
        
        console.log('✅ LocalBuy Dual Cache System Ready (Session + Local Storage)');

        // Global variables
        let allProducts = [];
        let filteredProducts = [];
        let isGridView = true;

        // Notification function
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notification-container') || createNotificationContainer();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }

        function createNotificationContainer() {
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'notification-container';
                document.body.appendChild(container);
            }
            return container;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            loadRecentlyViewed();
            updateWishlistDisplay();
            updateWishlistNavBadge();
            restoreUserPreferences();
            hideLoadingOverlay();
            
            console.log('✅ Dashboard with caching initialized');
        });

        function initializeDashboard() {
            // Extract product data
            const productCards = document.querySelectorAll('.product-card');
            allProducts = Array.from(productCards).map(card => {
                return JSON.parse(card.getAttribute('data-product'));
            });
            filteredProducts = [...allProducts];
            
            // Update stats
            updateStats();
            
            // Set price range max
            const maxPrice = Math.max(...allProducts.map(p => parseFloat(p.price)));
            const priceRange = document.getElementById('priceRange');
            priceRange.max = maxPrice;
            document.getElementById('priceValue').textContent = maxPrice;
        }

        function setupEventListeners() {
            // Search functionality with caching
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(performSearch, 300));
            
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            // Filters with preference saving
            document.getElementById('sortBy').addEventListener('change', () => {
                window.userSessionManager.savePreference('sortBy', document.getElementById('sortBy').value);
                applyFilters();
            });
            
            document.getElementById('priceRange').addEventListener('input', () => {
                updatePriceFilter();
                window.userSessionManager.savePreference('priceRange', document.getElementById('priceRange').value);
            });
            
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            // View toggle with preference saving
            document.getElementById('gridView').addEventListener('click', () => setViewMode('grid'));
            document.getElementById('listView').addEventListener('click', () => setViewMode('list'));
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // Cache search query
            if (query) {
                const searches = window.cache.get('search_history') || [];
                if (!searches.includes(query)) {
                    searches.unshift(query);
                    if (searches.length > 10) searches.pop();
                    window.cache.set('search_history', searches, 7 * 24 * 60); // 7 days
                }
            }
            
            if (query === '') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => {
                    return product.name.toLowerCase().includes(query) ||
                           product.description.toLowerCase().includes(query) ||
                           product.shopkeeper_name.toLowerCase().includes(query);
                });
            }
            
            applyFilters();
        }

        function applyFilters() {
            const sortBy = document.getElementById('sortBy').value;
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            
            // Filter by price
            let filtered = filteredProducts.filter(product => parseFloat(product.price) <= maxPrice);
            
            // Sort products
            switch(sortBy) {
                case 'name':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-low':
                    filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                    break;
                case 'price-high':
                    filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                    break;
                case 'shop':
                    filtered.sort((a, b) => a.shopkeeper_name.localeCompare(b.shopkeeper_name));
                    break;
                case 'recent':
                    // Sort by recently viewed/added (use cached data)
                    const recentlyViewed = window.cache.get('recently_viewed') || [];
                    filtered.sort((a, b) => {
                        const aIndex = recentlyViewed.indexOf(a.id.toString());
                        const bIndex = recentlyViewed.indexOf(b.id.toString());
                        return (aIndex !== -1 ? aIndex : 999) - (bIndex !== -1 ? bIndex : 999);
                    });
                    break;
            }
            
            displayProducts(filtered);
        }

        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');
            
            if (products.length === 0) {
                productGrid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                productGrid.style.display = isGridView ? 'grid' : 'block';
                noResults.style.display = 'none';
                
                // Hide all cards first
                const allCards = document.querySelectorAll('.product-card');
                allCards.forEach(card => card.style.display = 'none');
                
                // Show matching cards
                products.forEach(product => {
                    const card = document.querySelector(`[data-product*='"id":${product.id}']`);
                    if (card) {
                        card.style.display = 'block';
                        card.style.animation = 'fadeInUp 0.3s ease-out';
                    }
                });
            }
            
            // Update counts
            document.getElementById('visibleCount').textContent = products.length;
            document.getElementById('totalCount').textContent = allProducts.length;
        }

        function addToCart(productId, buttonEl) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const cartItem = {
                id: product.id,
                name: product.name,
                price: product.price,
                image: product.image_url,
                quantity: 1
            };

            // Add to both Session Storage cart (temporary) and Local Storage cart (persistent)
            window.cartManager.addItem(cartItem);
            
            // Also add to persistent cart if available
            if (window.persistentCart) {
                window.persistentCart.addItem(cartItem);
                console.log('✅ Added to both session and persistent carts');
            }

            const originalText = buttonEl.innerHTML;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            buttonEl.disabled = true;
            
            // Simulate API call (replace with actual server call)
            setTimeout(() => {
                buttonEl.innerHTML = '<i class="fas fa-check"></i> Added!';
                buttonEl.classList.add('success');
                
                setTimeout(() => {
                    buttonEl.innerHTML = originalText;
                    buttonEl.classList.remove('success');
                    buttonEl.disabled = false;
                }, 2000);
            }, 500);
        }

        function toggleWishlist(productId, buttonEl) {
            const product = allProducts.find(p => p.id === productId);
            if (!product || !window.persistentCart) return;

            const isInWishlist = window.persistentCart.isInWishlist(productId);
            const icon = buttonEl.querySelector('i');
            const text = buttonEl.querySelector('.wishlist-text');

            if (isInWishlist) {
                // Remove from wishlist
                window.persistentCart.removeFromWishlist(productId);
                icon.className = 'far fa-heart';
                text.textContent = 'Save';
                buttonEl.classList.remove('in-wishlist');
                showNotification('Removed from wishlist', 'info');
            } else {
                // Add to wishlist
                window.persistentCart.addToWishlist({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image_url,
                    shopkeeper_name: product.shopkeeper_name
                });
                icon.className = 'fas fa-heart';
                text.textContent = 'Saved';
                buttonEl.classList.add('in-wishlist');
                showNotification('Added to wishlist', 'success');
            }

            updateWishlistDisplay();
            updateWishlistNavBadge();
        }

        function updateWishlistDisplay() {
            if (!window.persistentCart) return;

            const wishlist = window.persistentCart.getWishlist();
            const wishlistSection = document.getElementById('wishlistSection');
            const wishlistGrid = document.getElementById('wishlistGrid');
            const wishlistCount = document.getElementById('wishlistCount');

            // Update count
            wishlistCount.textContent = wishlist.length;

            if (wishlist.length === 0) {
                wishlistSection.style.display = 'none';
                return;
            }

            wishlistSection.style.display = 'block';

            // Generate wishlist HTML
            wishlistGrid.innerHTML = wishlist.map(item => `
                <div class="product-card wishlist-item" data-product-id="${item.id}">
                    <div class="product-image">
                        <img src="${item.image || '/images/placeholder.jpg'}" alt="${item.name}" 
                             onerror="this.src='/images/placeholder.jpg'">
                        <button class="remove-from-wishlist" onclick="removeFromWishlistAndUpdate(${item.id})" 
                                title="Remove from wishlist">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="product-info">
                        <h4>${item.name}</h4>
                        <p class="product-price">₹${parseFloat(item.price).toFixed(2)}</p>
                        <p class="product-shop">by ${item.shopkeeper_name || 'Unknown'}</p>
                        <p class="added-date">Added ${new Date(item.addedAt).toLocaleDateString()}</p>
                    </div>
                    <div class="product-actions">
                        <button class="btn small primary" onclick="addToCartFromWishlist(${item.id})">
                            <i class="fas fa-cart-plus"></i>
                            Add to Cart
                        </button>
                        <button class="btn small secondary" onclick="showQuickView(${item.id})">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                    </div>
                </div>
            `).join('');

            // Update product buttons to show wishlist status
            updateProductWishlistButtons();
        }

        function updateProductWishlistButtons() {
            if (!window.persistentCart) return;

            document.querySelectorAll('.wishlist-btn').forEach(button => {
                const productId = parseInt(button.dataset.productId);
                const isInWishlist = window.persistentCart.isInWishlist(productId);
                const icon = button.querySelector('i');
                const text = button.querySelector('.wishlist-text');
                
                if (isInWishlist) {
                    icon.className = 'fas fa-heart';
                    text.textContent = 'Saved';
                    button.classList.add('in-wishlist');
                } else {
                    icon.className = 'far fa-heart';
                    text.textContent = 'Save';
                    button.classList.remove('in-wishlist');
                }
            });
        }

        function addToCartFromWishlist(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                addToCart(productId, document.createElement('button'));
                showNotification('Added to cart from wishlist', 'success');
            }
        }

        function removeFromWishlistAndUpdate(productId) {
            if (window.persistentCart) {
                window.persistentCart.removeFromWishlist(productId);
                updateWishlistDisplay();
                updateProductWishlistButtons();
                updateWishlistNavBadge();
                updateWishlistPanel();
                showNotification('Removed from wishlist', 'info');
            }
        }

        // Wishlist Panel Functions
        function toggleWishlistPanel(event) {
            event.preventDefault();
            const panel = document.getElementById('wishlistPanel');
            const overlay = document.getElementById('wishlistOverlay');
            
            if (panel.classList.contains('open')) {
                closeWishlistPanel();
            } else {
                openWishlistPanel();
            }
        }

        function openWishlistPanel() {
            const panel = document.getElementById('wishlistPanel');
            const overlay = document.getElementById('wishlistOverlay');
            const navButton = document.querySelector('.wishlist-nav');
            
            panel.classList.add('open');
            overlay.classList.add('open');
            navButton.classList.add('active');
            
            updateWishlistPanel();
        }

        function closeWishlistPanel() {
            const panel = document.getElementById('wishlistPanel');
            const overlay = document.getElementById('wishlistOverlay');
            const navButton = document.querySelector('.wishlist-nav');
            
            panel.classList.remove('open');
            overlay.classList.remove('open');
            navButton.classList.remove('active');
        }

        function updateWishlistPanel() {
            if (!window.persistentCart) return;

            const wishlist = window.persistentCart.getWishlist();
            const content = document.getElementById('wishlistPanelContent');

            if (wishlist.length === 0) {
                content.innerHTML = `
                    <div class="wishlist-panel-empty">
                        <i class="fas fa-heart" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                        <p>Your wishlist is empty</p>
                        <p>Save items you love to find them easily later!</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = wishlist.map(item => `
                <div class="wishlist-panel-item">
                    <img src="${item.image || '/images/placeholder.jpg'}" alt="${item.name}" 
                         onerror="this.src='/images/placeholder.jpg'">
                    <div class="wishlist-panel-item-info">
                        <div class="wishlist-panel-item-name">${item.name}</div>
                        <div class="wishlist-panel-item-price">₹${parseFloat(item.price).toFixed(2)}</div>
                        <div class="wishlist-panel-item-actions">
                            <button class="btn small primary" onclick="addToCartFromWishlistPanel(${item.id})">
                                <i class="fas fa-cart-plus"></i> Add to Cart
                            </button>
                            <button class="btn small secondary" onclick="removeFromWishlistPanel(${item.id})">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateWishlistNavBadge() {
            if (!window.persistentCart) return;
            
            const wishlist = window.persistentCart.getWishlist();
            const badge = document.getElementById('wishlist-nav-badge');
            badge.textContent = wishlist.length;
            badge.style.display = wishlist.length > 0 ? 'inline-block' : 'none';
        }

        function addToCartFromWishlistPanel(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                addToCart(productId, document.createElement('button'));
                showNotification('Added to cart from wishlist', 'success');
            }
        }

        function removeFromWishlistPanel(productId) {
            if (window.persistentCart) {
                window.persistentCart.removeFromWishlist(productId);
                updateWishlistDisplay();
                updateProductWishlistButtons();
                updateWishlistNavBadge();
                updateWishlistPanel();
                showNotification('Removed from wishlist', 'info');
            }
        }

        function loadRecentlyViewed() {
            const recentlyViewed = window.cache.get('recently_viewed') || [];
            if (recentlyViewed.length === 0) return;

            const section = document.getElementById('recentlyViewedSection');
            const grid = document.getElementById('recentlyViewedGrid');
            
            let html = '';
            recentlyViewed.slice(0, 5).forEach(productId => {
                const product = allProducts.find(p => p.id.toString() === productId);
                if (product) {
                    html += `
                        <div class="recent-product-card" data-product-id="${product.id}">
                            <div class="recent-product-image">
                                ${product.image_url ? 
                                    `<img src="${product.image_url}" alt="${product.name}">` : 
                                    '<div class="no-image"><i class="fas fa-image"></i></div>'
                                }
                            </div>
                            <h4>${product.name}</h4>
                            <p class="price">₹${product.price}</p>
                            <button class="btn small primary" onclick="addToCart(${product.id}, this)">
                                Add to Cart
                            </button>
                        </div>
                    `;
                }
            });
            
            if (html) {
                grid.innerHTML = html;
                section.style.display = 'block';
            }
        }

        function restoreUserPreferences() {
            // Restore filter preferences
            const sortBy = window.userSessionManager.getPreference('sortBy');
            if (sortBy) {
                document.getElementById('sortBy').value = sortBy;
            }
            
            const priceRange = window.userSessionManager.getPreference('priceRange');
            if (priceRange) {
                document.getElementById('priceRange').value = priceRange;
                document.getElementById('priceValue').textContent = priceRange;
            }
            
            const viewMode = window.userSessionManager.getPreference('viewMode') || 'grid';
            setViewMode(viewMode);
            
            // Apply saved filters
            applyFilters();
        }

        function setViewMode(mode) {
            isGridView = mode === 'grid';
            const productGrid = document.getElementById('productGrid');
            
            document.getElementById('gridView').classList.toggle('active', isGridView);
            document.getElementById('listView').classList.toggle('active', !isGridView);
            
            if (isGridView) {
                productGrid.classList.remove('list-view');
                productGrid.classList.add('grid-view');
            } else {
                productGrid.classList.remove('grid-view');
                productGrid.classList.add('list-view');
            }
            
            // Save preference
            window.userSessionManager.savePreference('viewMode', mode);
        }

        function toggleTheme() {
            const currentTheme = window.userSessionManager.getPreference('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            window.userSessionManager.setTheme(newTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function updatePriceFilter() {
            const priceRange = document.getElementById('priceRange');
            const priceValue = document.getElementById('priceValue');
            priceValue.textContent = priceRange.value;
            
            debounce(applyFilters, 150)();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'name';
            
            const priceRange = document.getElementById('priceRange');
            priceRange.value = priceRange.max;
            document.getElementById('priceValue').textContent = priceRange.max;
            
            // Clear saved preferences
            window.userSessionManager.clearPreference('sortBy');
            window.userSessionManager.clearPreference('priceRange');
            
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function openQuickView(index) {
            const product = allProducts[index];
            
            // Track in recently viewed
            const recentlyViewed = window.cache.get('recently_viewed') || [];
            const productIdStr = product.id.toString();
            
            // Remove if already exists
            const existingIndex = recentlyViewed.indexOf(productIdStr);
            if (existingIndex > -1) {
                recentlyViewed.splice(existingIndex, 1);
            }
            
            // Add to beginning
            recentlyViewed.unshift(productIdStr);
            
            // Keep only last 10
            if (recentlyViewed.length > 10) {
                recentlyViewed.pop();
            }
            
            window.cache.set('recently_viewed', recentlyViewed, 24 * 60); // 24 hours
            
            // Show modal
            const modal = document.getElementById('quickViewModal');
            const content = document.getElementById('quickViewContent');
            
            content.innerHTML = `
                <div class="quick-view-product">
                    <div class="quick-view-image">
                        ${product.image_url ? 
                            `<img src="${product.image_url}" alt="${product.name}">` : 
                            `<div class="no-image"><i class="fas fa-image"></i><span>No Image</span></div>`
                        }
                    </div>
                    <div class="quick-view-info">
                        <h2>${product.name}</h2>
                        <div class="product-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span>(4.8 stars)</span>
                        </div>
                        <p class="description">${product.description}</p>
                        <div class="price-section">
                            <span class="price">₹${product.price}</span>
                        </div>
                        <div class="shop-info">
                            <i class="fas fa-store-alt"></i>
                            <span>Sold by: ${product.shopkeeper_name}</span>
                        </div>
                        <div class="quick-view-actions">
                            <button class="btn primary" onclick="addToCart(${product.id}, this); closeQuickView();">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                            <button class="btn secondary" onclick="quickBuy(${product.id})">
                                <i class="fas fa-bolt"></i> Quick Buy
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeQuickView() {
            document.getElementById('quickViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function quickBuy(productId) {
            addToCart(productId, document.createElement('button'));
            setTimeout(() => {
                window.location.href = '/user/cart';
            }, 1000);
        }

        function updateStats() {
            const uniqueShops = new Set(allProducts.map(p => p.shopkeeper_name)).size;
            document.getElementById('totalShops').textContent = uniqueShops;
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Escape to close modal
            if (e.key === 'Escape') {
                closeQuickView();
            }
        }

        function hideLoadingOverlay() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
        }

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>