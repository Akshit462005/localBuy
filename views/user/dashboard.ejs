<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - LocalBuy</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-store"></i>
                LocalBuy
            </div>
            <div class="nav-links">
                <a href="/user/cart" class="nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Cart</span>
                    <span class="cart-count" id="cartCount">0</span>
                </a>
                <a href="/user/orders" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
                <a href="/auth/logout" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="dashboard-header">
            <div class="welcome-section">
                <h1><i class="fas fa-home"></i> Welcome to Your Dashboard</h1>
                <p class="dashboard-subtitle">Discover amazing products from local shopkeepers</p>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-box-open"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalProducts"><%= products.length %></span>
                        <span class="stat-label">Available Products</span>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-store"></i>
                    <div class="stat-info">
                        <span class="stat-number" id="totalShops">0</span>
                        <span class="stat-label">Active Shops</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-section">
            <div class="search-filter-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search products, shops, or descriptions...">
                    <button id="clearSearch" class="clear-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="filter-controls">
                    <select id="sortBy" class="filter-select">
                        <option value="name">Sort by Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="shop">Shop Name</option>
                    </select>
                    
                    <div class="price-filter">
                        <label for="priceRange">Max Price: ‚Çπ<span id="priceValue">1000</span></label>
                        <input type="range" id="priceRange" min="0" max="1000" value="1000">
                    </div>
                    
                    <button id="resetFilters" class="btn secondary">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            
            <div class="view-toggle">
                <button id="gridView" class="view-btn active">
                    <i class="fas fa-th-large"></i>
                </button>
                <button id="listView" class="view-btn">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>

        <div class="products-section">
            <div class="section-header">
                <h2>Available Products</h2>
                <span class="product-count">Showing <span id="visibleCount"><%= products.length %></span> of <span id="totalCount"><%= products.length %></span> products</span>
            </div>
            
            <div class="product-grid" id="productGrid">
                <% products.forEach((product, index) => { %>
                    <div class="product-card" data-product='<%= JSON.stringify(product) %>' data-index="<%= index %>">
                        <div class="product-image">
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" loading="lazy">
                            <% } else { %>
                                <div class="no-image">
                                    <i class="fas fa-image"></i>
                                    <span>No Image</span>
                                </div>
                            <% } %>
                            <div class="product-overlay">
                                <button class="quick-view-btn" onclick="openQuickView(<%= index %>)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="wishlist-btn" data-product-id="<%= product.id %>" onclick="toggleWishlist(<%= product.id %>, this)">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="product-info">
                            <div class="product-header">
                                <h3 class="product-name"><%= product.name %></h3>
                                <div class="product-rating">
                                    <% for(let i = 0; i < 5; i++) { %>
                                        <i class="fas fa-star"></i>
                                    <% } %>
                                    <span class="rating-text">(4.8)</span>
                                </div>
                            </div>
                            
                            <p class="product-description"><%= product.description %></p>
                            
                            <div class="product-meta">
                                <p class="price">
                                    <span class="currency">‚Çπ</span>
                                    <span class="amount"><%= product.price %></span>
                                </p>
                                <div class="stock-info">
                                    <% if (product.stock_quantity > 10) { %>
                                        <span class="stock-badge available">
                                            <i class="fas fa-check-circle"></i>
                                            In Stock (<%= product.stock_quantity %>)
                                        </span>
                                    <% } else if (product.stock_quantity > 0) { %>
                                        <span class="stock-badge limited">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Only <%= product.stock_quantity %> left
                                        </span>
                                    <% } else { %>
                                        <span class="stock-badge unavailable">
                                            <i class="fas fa-times-circle"></i>
                                            Out of Stock
                                        </span>
                                    <% } %>
                                </div>
                                <p class="shop-name">
                                    <i class="fas fa-store-alt"></i>
                                    <%= product.shopkeeper_name %>
                                </p>
                            </div>
                            
                            <div class="product-actions">
                                <% if (product.stock_quantity > 0) { %>
                                    <button class="btn primary add-to-cart-btn" onclick="addToCart(<%= product.id %>, this)">
                                        <i class="fas fa-shopping-cart"></i>
                                        <span>Add to Cart</span>
                                    </button>
                                    <button class="btn secondary quick-buy-btn" onclick="quickBuy(<%= product.id %>)">
                                        <i class="fas fa-bolt"></i>
                                        Quick Buy
                                    </button>
                                <% } else { %>
                                    <button class="btn disabled" disabled>
                                        <i class="fas fa-ban"></i>
                                        <span>Out of Stock</span>
                                    </button>
                                    <button class="btn secondary" onclick="notifyWhenAvailable(<%= product.id %>)">
                                        <i class="fas fa-bell"></i>
                                        Notify Me
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div id="noResults" class="no-results" style="display: none;">
                <i class="fas fa-search"></i>
                <h3>No products found</h3>
                <p>Try adjusting your search criteria or filters</p>
            </div>
        </div>
    </main>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeQuickView()">
                <i class="fas fa-times"></i>
            </button>
            <div id="quickViewContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>LocalBuy</h4>
                <p>Connecting local businesses with customers</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="/user/dashboard">Dashboard</a>
                <a href="/user/cart">Cart</a>
                <a href="/user/orders">Orders</a>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Contact Us</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 LocalBuy. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Global variables
        let allProducts = [];
        let filteredProducts = [];
        let isGridView = true;
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            updateCartCount();
            hideLoadingOverlay();
            
            // Apply initial filters/sort
            applyFilters();
        });

        function initializeDashboard() {
            // Extract product data
            const productCards = document.querySelectorAll('.product-card');
            allProducts = Array.from(productCards).map(card => {
                return JSON.parse(card.getAttribute('data-product'));
            });
            filteredProducts = [...allProducts];
            
            // Update stats
            updateStats();
            
            // Set price range max
            const maxPrice = Math.max(...allProducts.map(p => parseFloat(p.price)));
            const priceRange = document.getElementById('priceRange');
            priceRange.max = maxPrice;
            priceRange.value = maxPrice;
            document.getElementById('priceValue').textContent = maxPrice;
            
            // Initialize wishlist UI after DOM is ready
            setTimeout(() => {
                updateWishlistUI();
                console.log('‚úÖ Wishlist UI initialized with', wishlist.length, 'items');
            }, 100);
        }

        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(performSearch, 300));
            
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            // Filters
            document.getElementById('sortBy').addEventListener('change', applyFilters);
            document.getElementById('priceRange').addEventListener('input', updatePriceFilter);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            // View toggle
            document.getElementById('gridView').addEventListener('click', () => setViewMode('grid'));
            document.getElementById('listView').addEventListener('click', () => setViewMode('list'));
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const sortBy = document.getElementById('sortBy').value;
            const maxPrice = document.getElementById('priceRange').value;
            
            try {
                showSearchLoading(true);
                
                // Build query parameters
                const params = new URLSearchParams();
                if (query) params.append('query', query);
                if (sortBy) params.append('sortBy', sortBy);
                if (maxPrice) params.append('maxPrice', maxPrice);
                params.append('page', '1');
                params.append('limit', '50');
                
                const response = await fetch(`/user/api/search?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    // Update the product grid with server results
                    updateProductGridWithServerResults(data.products);
                    
                    // Update pagination if needed
                    if (data.pagination && data.pagination.totalPages > 1) {
                        updateSearchPagination(data.pagination);
                    }
                    
                    console.log(`üîç Server search returned ${data.products.length} results`);
                } else {
                    console.error('Search failed:', data.error);
                    showSearchError('Search failed. Please try again.');
                }
            } catch (error) {
                console.error('Error performing search:', error);
                showSearchError('Connection error. Using cached results.');
                // Fallback to client-side search
                performClientSideSearch();
            } finally {
                showSearchLoading(false);
            }
        }

        function performClientSideSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (query === '') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => {
                    return product.name.toLowerCase().includes(query) ||
                           product.description.toLowerCase().includes(query) ||
                           product.shopkeeper_name.toLowerCase().includes(query);
                });
            }
            
            applyFilters();
        }

        function updateProductGridWithServerResults(products) {
            const productGrid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');
            
            if (products.length === 0) {
                productGrid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            productGrid.style.display = isGridView ? 'grid' : 'block';
            noResults.style.display = 'none';
            
            // Clear existing products
            productGrid.innerHTML = '';
            
            // Add new products
            products.forEach(product => {
                const productCard = createProductCard(product);
                productGrid.appendChild(productCard);
            });
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = `product-card ${isGridView ? 'grid-view' : 'list-view'}`;
            card.setAttribute('data-product', JSON.stringify(product));
            
            const imageUrl = product.image_url || '/images/placeholder-product.jpg';
            const isInWishlist = isProductInWishlist(product.id);
            
            card.innerHTML = `
                <div class="product-image">
                    <img src="${imageUrl}" alt="${product.name}" onerror="this.src='/images/placeholder-product.jpg'">
                    <div class="product-badges">
                        <span class="badge new">New</span>
                    </div>
                    <button class="wishlist-btn ${isInWishlist ? 'active' : ''}" data-product-id="${product.id}" onclick="toggleWishlist(${product.id}, this)" title="Add to Wishlist">
                        <i class="${isInWishlist ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                </div>
                <div class="product-info">
                    <div class="product-details">
                        <h3 class="product-name" title="${product.name}">${product.name}</h3>
                        <p class="product-description" title="${product.description}">${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}</p>
                        <div class="shopkeeper-info">
                            <i class="fas fa-store"></i>
                            <span>by ${product.shopkeeper_name}</span>
                        </div>
                    </div>
                    <div class="product-actions">
                        <div class="price-section">
                            <span class="current-price">‚Çπ${parseFloat(product.price).toLocaleString()}</span>
                        </div>
                        <button class="btn primary add-to-cart-btn" onclick="addToCart(${product.id})" title="Add to Cart">
                            <i class="fas fa-cart-plus"></i>
                            <span>Add to Cart</span>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function showSearchLoading(show) {
            const searchInput = document.getElementById('searchInput');
            const productGrid = document.getElementById('productGrid');
            
            if (show) {
                searchInput.style.opacity = '0.6';
                if (!document.getElementById('searchLoading')) {
                    const loader = document.createElement('div');
                    loader.id = 'searchLoading';
                    loader.className = 'search-loading';
                    loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                    productGrid.parentNode.insertBefore(loader, productGrid);
                }
            } else {
                searchInput.style.opacity = '1';
                const loader = document.getElementById('searchLoading');
                if (loader) loader.remove();
            }
        }

        function showSearchError(message) {
            const toast = document.createElement('div');
            toast.className = 'search-error-toast';
            toast.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.trim();
            
            // If there's a search query, use server-side search with filters
            if (searchQuery) {
                performSearch();
                return;
            }
            
            // Otherwise apply client-side filters to all products
            const sortBy = document.getElementById('sortBy').value;
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            
            // Filter by price
            let filtered = filteredProducts.filter(product => parseFloat(product.price) <= maxPrice);
            
            // Sort products
            switch(sortBy) {
                case 'name':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-low':
                    filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                    break;
                case 'price-high':
                    filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                    break;
                case 'shop':
                    filtered.sort((a, b) => a.shopkeeper_name.localeCompare(b.shopkeeper_name));
                    break;
            }
            
            displayProducts(filtered);
        }

        function displayProducts(products) {
            const productGrid = document.getElementById('productGrid');
            const noResults = document.getElementById('noResults');
            
            if (products.length === 0) {
                productGrid.style.display = 'none';
                noResults.style.display = 'block';
            } else {
                productGrid.style.display = isGridView ? 'grid' : 'block';
                noResults.style.display = 'none';
                
                // Get all existing cards
                const allCards = Array.from(document.querySelectorAll('.product-card'));
                
                // Hide all cards first
                allCards.forEach(card => card.style.display = 'none');
                
                // Create a map for quick lookups
                const cardMap = new Map();
                allCards.forEach(card => {
                    try {
                        const cardData = JSON.parse(card.getAttribute('data-product'));
                        cardMap.set(cardData.id, card);
                    } catch (e) {
                        console.warn('Could not parse card data:', card);
                    }
                });
                
                // Reorder and show cards according to the sorted products
                const fragment = document.createDocumentFragment();
                products.forEach((product, index) => {
                    const card = cardMap.get(product.id);
                    if (card) {
                        // Update the data-index for proper functionality
                        card.setAttribute('data-index', index);
                        card.style.display = 'block';
                        card.style.animation = 'fadeInUp 0.3s ease-out';
                        
                        // Remove from current position and add to fragment
                        card.remove();
                        fragment.appendChild(card);
                    }
                });
                
                // Add all sorted cards back to the grid
                productGrid.appendChild(fragment);
            }
            
            // Update counts
            document.getElementById('visibleCount').textContent = products.length;
            document.getElementById('totalCount').textContent = allProducts.length;
        }

        function updatePriceFilter() {
            const priceRange = document.getElementById('priceRange');
            const priceValue = document.getElementById('priceValue');
            priceValue.textContent = priceRange.value;
            
            debounce(applyFilters, 150)();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'name';
            
            const priceRange = document.getElementById('priceRange');
            priceRange.value = priceRange.max;
            document.getElementById('priceValue').textContent = priceRange.max;
            
            filteredProducts = [...allProducts];
            applyFilters();
        }

        function setViewMode(mode) {
            isGridView = mode === 'grid';
            const productGrid = document.getElementById('productGrid');
            
            document.getElementById('gridView').classList.toggle('active', isGridView);
            document.getElementById('listView').classList.toggle('active', !isGridView);
            
            if (isGridView) {
                productGrid.classList.remove('list-view');
                productGrid.classList.add('grid-view');
            } else {
                productGrid.classList.remove('grid-view');
                productGrid.classList.add('list-view');
            }
        }

        async function addToCart(productId, buttonEl) {
            const originalText = buttonEl.innerHTML;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            buttonEl.disabled = true;
            
            console.log('üõí Adding product to cart:', productId);
            
            try {
                // Find product data
                const product = allProducts.find(p => p.id === productId);
                if (!product) {
                    throw new Error('Product not found');
                }
                
                // Use cart sync manager if available
                if (window.cartSyncManager) {
                    console.log('üîÑ Using cart sync manager');
                    await window.cartSyncManager.addItem(product);
                    
                    // Success animation
                    buttonEl.innerHTML = '<i class="fas fa-check"></i> Added!';
                    buttonEl.classList.add('success');
                } else {
                    // Fallback to traditional API call
                    console.log('‚ö†Ô∏è Cart sync manager not available, using fallback');
                    
                    const response = await fetch('/user/add-to-cart?format=json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: `productId=${productId}`
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Failed to add to cart`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update cart count from server response
                        const cartCount = data.cart.count || 0;
                        
                        // Use global cart counter if available
                        if (window.cartCounter) {
                            window.cartCounter.updateCartElements(cartCount);
                        } else {
                            // Fallback to manual update
                            const cartCountEl = document.getElementById('cartCount');
                            if (cartCountEl) {
                                cartCountEl.textContent = cartCount;
                            }
                        }
                        
                        showToast(data.message || 'Product added to cart!', 'success');
                        
                        // Success animation
                        buttonEl.innerHTML = '<i class="fas fa-check"></i> Added!';
                        buttonEl.classList.add('success');
                    } else {
                        throw new Error(data.error || 'Failed to add to cart');
                    }
                }
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    buttonEl.innerHTML = originalText;
                    buttonEl.classList.remove('success');
                    buttonEl.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showToast('Failed to add to cart', 'error');
                buttonEl.innerHTML = originalText;
                buttonEl.disabled = false;
            }
        }

        function quickBuy(productId) {
            showToast('Redirecting to checkout...', 'info');
            // Add to cart and redirect to checkout
            fetch('/user/add-to-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}`
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/user/cart';
                }
            })
            .catch(error => {
                showToast('Error processing quick buy', 'error');
            });
        }

        function isProductInWishlist(productId) {
            return wishlist.includes(productId);
        }

        function toggleWishlist(productId, buttonElement) {
            const index = wishlist.indexOf(productId);
            if (index > -1) {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist', 'info');
            } else {
                wishlist.push(productId);
                showToast('Added to wishlist', 'success');
            }
            
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            
            // Update the specific button immediately if passed
            if (buttonElement) {
                updateSingleWishlistButton(buttonElement, productId);
            } else {
                updateWishlistUI();
            }
        }

        function updateSingleWishlistButton(button, productId) {
            const icon = button.querySelector('i');
            
            if (wishlist.includes(productId)) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.classList.add('active');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.classList.remove('active');
            }
        }

        function updateWishlistUI() {
            const wishlistBtns = document.querySelectorAll('.wishlist-btn');
            wishlistBtns.forEach((btn) => {
                // Get product ID from the button's onclick attribute or data attribute
                const onclickAttr = btn.getAttribute('onclick');
                let productId = null;
                
                if (onclickAttr) {
                    const match = onclickAttr.match(/toggleWishlist\(([^,)]+)/);
                    if (match) {
                        productId = parseInt(match[1]);
                    }
                }
                
                // Fallback: check if button has data-product-id
                if (!productId) {
                    productId = parseInt(btn.getAttribute('data-product-id'));
                }
                
                if (productId) {
                    updateSingleWishlistButton(btn, productId);
                }
            });
        }

        function openQuickView(index) {
            const product = allProducts[index];
            const modal = document.getElementById('quickViewModal');
            const content = document.getElementById('quickViewContent');
            
            content.innerHTML = `
                <div class="quick-view-product">
                    <div class="quick-view-image">
                        ${product.image_url ? 
                            `<img src="${product.image_url}" alt="${product.name}">` : 
                            `<div class="no-image"><i class="fas fa-image"></i><span>No Image</span></div>`
                        }
                    </div>
                    <div class="quick-view-info">
                        <h2>${product.name}</h2>
                        <div class="product-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <span>(4.8 stars)</span>
                        </div>
                        <p class="description">${product.description}</p>
                        <div class="price-section">
                            <span class="price">‚Çπ${product.price}</span>
                        </div>
                        <div class="shop-info">
                            <i class="fas fa-store-alt"></i>
                            <span>Sold by: ${product.shopkeeper_name}</span>
                        </div>
                        <div class="quick-view-actions">
                            <button class="btn primary" onclick="addToCart(${product.id}, this); closeQuickView();">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                            <button class="btn secondary" onclick="quickBuy(${product.id})">
                                <i class="fas fa-bolt"></i> Quick Buy
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeQuickView() {
            document.getElementById('quickViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function updateCartCount() {
            // Use the global cart counter if available, otherwise fallback to local implementation
            if (window.cartCounter) {
                window.cartCounter.refresh();
            } else {
                // Fallback implementation
                fetch('/user/cart?format=json')
                    .then(response => {
                        if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Non-JSON response received');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            const cartCount = data.cart.count || 0;
                            document.getElementById('cartCount').textContent = cartCount;
                            
                            // Also update any cart badge elements
                            const cartBadges = document.querySelectorAll('.cart-badge, .cart-count');
                            cartBadges.forEach(badge => {
                                badge.textContent = cartCount;
                                badge.style.display = cartCount > 0 ? 'inline' : 'none';
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Failed to update cart count:', error);
                        document.getElementById('cartCount').textContent = '0';
                        
                        // Update cart badges to show 0
                        const cartBadges = document.querySelectorAll('.cart-badge, .cart-count');
                        cartBadges.forEach(badge => {
                            badge.textContent = '0';
                            badge.style.display = 'none';
                        });
                    });
            }
        }

        function updateStats() {
            const uniqueShops = new Set(allProducts.map(p => p.shopkeeper_name)).size;
            document.getElementById('totalShops').textContent = uniqueShops;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-triangle'
            }[type];
            
            toast.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 4000);
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + F to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Escape to close modal
            if (e.key === 'Escape') {
                closeQuickView();
            }
        }

        function hideLoadingOverlay() {
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 500);
        }

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Stock Notification Function
        async function notifyWhenAvailable(productId) {
            const product = allProducts.find(p => p.id === productId);
            
            if (!product) {
                showToast('Product not found', 'error');
                console.error('‚ùå Product not found:', productId);
                return;
            }
            
            try {
                console.log(`üîî Setting up notification for product: ${product.name} (ID: ${productId})`);
                
                // Send to backend
                const response = await fetch('/user/api/notify-when-available', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId: productId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Save locally for UI consistency
                    let notifications = JSON.parse(localStorage.getItem('stockNotifications') || '[]');
                    if (!notifications.includes(productId)) {
                        notifications.push(productId);
                        localStorage.setItem('stockNotifications', JSON.stringify(notifications));
                    }
                    
                    showToast(`‚úÖ You'll be notified when "${product.name}" is back in stock! Check your email for updates.`, 'success');
                    console.log('üìß Notification subscription created:', data.notificationId);
                    
                    // Update the button state if it exists
                    const button = document.querySelector(`[data-product-id="${productId}"] .notify-btn`);
                    if (button) {
                        button.disabled = true;
                        button.textContent = '‚úì Notifications Enabled';
                        button.style.opacity = '0.6';
                    }
                } else {
                    showToast(data.error || 'Failed to set up notification', 'error');
                    console.error('‚ùå Subscription error:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Error setting up notification:', error);
                showToast('Failed to set up notification. Please try again.', 'error');
            }
        }

        // Check notification status on page load
        async function checkNotificationStatus() {
            try {
                const notifications = JSON.parse(localStorage.getItem('stockNotifications') || '[]');
                console.log(`üìã Checking notification status for ${notifications.length} products`);
                
                // Update button states for all subscribed products
                notifications.forEach(productId => {
                    const button = document.querySelector(`[data-product-id="${productId}"] .notify-btn`);
                    if (button) {
                        button.disabled = true;
                        button.textContent = '‚úì Notifications Enabled';
                        button.style.opacity = '0.6';
                    }
                });
            } catch (error) {
                console.error('Error checking notification status:', error);
            }
        }

        // Call checkNotificationStatus after initialization
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing DOMContentLoaded code ...
            setTimeout(checkNotificationStatus, 500);
        });
    </script>
    <script src="/js/cart-sync-manager.js"></script>
    <script src="/js/cart-counter.js"></script>
</body>
</html>