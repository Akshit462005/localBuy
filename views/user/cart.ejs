<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - LocalBuy</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Define cart functions immediately in HEAD to ensure they're available -->
    <script>
        console.log('üöÄ Defining comprehensive cart functions in HEAD...');
        
        // Clear entire cart
        window.clearCart = function() {
            console.log('üßπ clearCart called - comprehensive version');
            if (!confirm('Are you sure you want to clear your entire cart? This action cannot be undone.')) {
                return;
            }
            
            // Clear all storage first to prevent restoration
            try {
                localStorage.removeItem('localBuy_cart');
                localStorage.removeItem('cart_data');
                localStorage.removeItem('localbuy_cart');
                sessionStorage.removeItem('cart_data');
                // Set a flag to indicate cart was intentionally cleared
                localStorage.setItem('cart_cleared_at', Date.now().toString());
                console.log('üóëÔ∏è Cleared all local storage and set clear flag');
            } catch(e) { console.log('Storage clear error:', e); }
            
            // Get all cart items and remove them
            const cartItems = document.querySelectorAll('.enhanced-cart-item');
            const itemIds = Array.from(cartItems).map(item => item.getAttribute('data-item-id')).filter(id => id);
            
            if (itemIds.length === 0) {
                // Also send a clear request to server to update timestamp
                fetch('/user/clear-cart', { method: 'POST' })
                    .then(() => window.location.href = '/user/dashboard')
                    .catch(() => window.location.href = '/user/dashboard');
                return;
            }
            
            // Remove all items from server
            Promise.all(itemIds.map(itemId => 
                fetch(`/user/remove-from-cart/${itemId}`, { method: 'DELETE' })
            )).then(() => {
                // Send clear cart request to update server timestamp
                fetch('/user/clear-cart', { method: 'POST' })
                    .then(() => window.location.href = '/user/dashboard')
                    .catch(() => window.location.href = '/user/dashboard');
            }).catch(err => {
                console.error('Clear cart error:', err);
                window.location.href = '/user/dashboard';
            });
        };
        
        // Remove single item
        window.removeItem = function(itemId) {
            console.log('üóëÔ∏è removeItem called for item:', itemId);
            if (!confirm('Are you sure you want to remove this item?')) {
                return;
            }
            
            fetch(`/user/remove-from-cart/${itemId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove from DOM immediately
                        const cartItem = document.querySelector(`[data-item-id="${itemId}"]`);
                        if (cartItem) cartItem.remove();
                        
                        // Clear cache to prevent restoration
                        try {
                            localStorage.removeItem('localBuy_cart');
                            localStorage.removeItem('localbuy_cart');
                            localStorage.removeItem('cart_data');
                            sessionStorage.removeItem('cart_data');
                            localStorage.setItem('cart_cleared_at', Date.now().toString());
                        } catch(e) {}
                        
                        // Reload after short delay
                        setTimeout(() => window.location.reload(), 500);
                    }
                })
                .catch(err => {
                    console.error('Remove error:', err);
                    window.location.reload();
                });
        };
        
        // Toggle select all checkboxes
        window.toggleSelectAll = function() {
            console.log('üìã toggleSelectAll called');
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            if (selectAll && checkboxes) {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                window.updateSelection();
            }
        };
        
        // Update selection display
        window.updateSelection = function() {
            console.log('‚úÖ updateSelection called');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const removeButton = document.getElementById('removeSelected');
            if (removeButton) {
                if (selectedCount > 0) {
                    removeButton.style.display = 'inline-block';
                    removeButton.innerHTML = `<i class="fas fa-trash"></i> Remove Selected (${selectedCount})`;
                } else {
                    removeButton.style.display = 'none';
                }
            }
        };
        
        // Remove selected items
        window.removeSelected = function() {
            console.log('üóëÔ∏è removeSelected called');
            const selectedCheckboxes = Array.from(document.querySelectorAll('.item-checkbox:checked'));
            if (selectedCheckboxes.length === 0) {
                alert('No items selected');
                return;
            }
            
            if (!confirm(`Remove ${selectedCheckboxes.length} selected items?`)) {
                return;
            }
            
            const itemIds = selectedCheckboxes.map(cb => {
                const cartItem = cb.closest('.enhanced-cart-item');
                return cartItem ? cartItem.getAttribute('data-item-id') : null;
            }).filter(id => id);
            
            // Clear cache first
            try {
                localStorage.removeItem('localBuy_cart');
                localStorage.removeItem('localbuy_cart');
                localStorage.removeItem('cart_data');
                sessionStorage.removeItem('cart_data');
                localStorage.setItem('cart_cleared_at', Date.now().toString());
            } catch(e) {}
            
            Promise.all(itemIds.map(itemId => 
                fetch(`/user/remove-from-cart/${itemId}`, { method: 'DELETE' })
            )).then(() => {
                window.location.reload();
            }).catch(err => {
                console.error('Remove selected error:', err);
                window.location.reload();
            });
        };
        
        // Update quantity
        window.updateQuantity = function(itemId, action, value) {
            console.log('üìä updateQuantity called:', itemId, action, value);
            const quantityInput = document.getElementById(`quantity-${itemId}`);
            if (!quantityInput) return;
            
            let currentQuantity = parseInt(quantityInput.value) || 1;
            let newQuantity = currentQuantity;
            
            switch(action) {
                case 'increase':
                    newQuantity = Math.min(currentQuantity + 1, 99);
                    break;
                case 'decrease':
                    newQuantity = Math.max(currentQuantity - 1, 1);
                    break;
                case 'set':
                    newQuantity = Math.max(1, Math.min(parseInt(value) || 1, 99));
                    break;
            }
            
            if (newQuantity !== currentQuantity) {
                quantityInput.value = newQuantity;
                
                // Update server
                fetch('/user/update-cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${itemId}&quantity=${newQuantity}`
                }).then(response => {
                    if (response.ok) {
                        // Update subtotal display
                        const cartItem = document.querySelector(`[data-item-id="${itemId}"]`);
                        const price = parseFloat(cartItem.getAttribute('data-price'));
                        const subtotal = (price * newQuantity).toFixed(2);
                        const subtotalElement = document.getElementById(`subtotal-${itemId}`);
                        if (subtotalElement) {
                            subtotalElement.textContent = `‚Çπ${subtotal}`;
                        }
                    }
                }).catch(err => console.error('Update quantity error:', err));
            }
        };
        
        console.log('‚úÖ Comprehensive cart functions defined in HEAD and available globally');
    </script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <i class="fas fa-store"></i>
                LocalBuy
            </div>
            <div class="nav-links">
                <a href="/user/dashboard" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/user/orders" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Orders</span>
                </a>
                <a href="/auth/logout" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </header>

    <main class="enhanced-cart-container">
        <div class="cart-header">
            <h1><i class="fas fa-shopping-cart"></i> Your Shopping Cart</h1>
            <div class="cart-actions">
                <button id="clearCart" class="btn secondary" onclick="clearCart()" <% if (cart.length === 0) { %>style="display: none;"<% } %>>
                    <i class="fas fa-trash"></i> Clear Cart
                </button>
                <a href="/user/dashboard" class="btn outline">
                    <i class="fas fa-arrow-left"></i> Continue Shopping
                </a>
            </div>
        </div>

        <% if (cart.length === 0) { %>
            <div class="empty-cart">
                <div class="empty-cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h2>Your cart is empty</h2>
                <p>Looks like you haven't added any items to your cart yet.</p>
                <a href="/user/dashboard" class="btn primary large">
                    <i class="fas fa-store"></i> Start Shopping
                </a>
            </div>
        <% } else { %>
            <div class="cart-content">
                <div class="cart-items">
                    <div class="cart-items-header">
                        <h2>Items in Cart (<span id="itemCount"><%= cart.length %></span>)</h2>
                        <div class="bulk-actions">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll">Select All</label>
                            <button id="removeSelected" class="btn danger small" onclick="removeSelected()" style="display: none;">
                                <i class="fas fa-trash"></i> Remove Selected
                            </button>
                        </div>
                    </div>
                    
                    <% cart.forEach((item, index) => { %>
                        <div class="enhanced-cart-item" data-item-id="<%= item.id %>" data-price="<%= item.price %>">
                            <div class="item-selection">
                                <input type="checkbox" class="item-checkbox" onchange="updateSelection()">
                            </div>
                            
                            <div class="item-image">
                                <% if (item.image_url) { %>
                                    <img src="<%= item.image_url %>" alt="<%= item.name %>">
                                <% } else { %>
                                    <div class="no-image">
                                        <i class="fas fa-image"></i>
                                    </div>
                                <% } %>
                            </div>
                            
                            <div class="item-details">
                                <h3 class="item-name"><%= item.name %></h3>
                                <p class="item-description"><%= item.description || 'No description available' %></p>
                                <div class="item-meta">
                                    <span class="item-price">‚Çπ<%= item.price %></span>
                                    <% if (item.shopkeeper_name) { %>
                                        <span class="item-seller">
                                            <i class="fas fa-store-alt"></i>
                                            Sold by: <%= item.shopkeeper_name %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="item-quantity">
                                <label>Quantity:</label>
                                <div class="quantity-controls">
                                    <button type="button" class="quantity-btn minus" onclick="updateQuantity(<%= item.id %>, 'decrease')">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" 
                                           id="quantity-<%= item.id %>" 
                                           value="<%= item.quantity %>" 
                                           min="1" 
                                           max="99"
                                           onchange="updateQuantity(<%= item.id %>, 'set', this.value)">
                                    <button type="button" class="quantity-btn plus" onclick="updateQuantity(<%= item.id %>, 'increase')">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="item-total">
                                <div class="subtotal-label">Subtotal:</div>
                                <div class="subtotal-amount" id="subtotal-<%= item.id %>">‚Çπ<%= (item.price * item.quantity).toFixed(2) %></div>
                            </div>
                            
                            <div class="item-actions">
                                <button class="action-btn save-later" title="Save for Later">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="action-btn remove" onclick="removeItem(<%= item.id %>)" title="Remove Item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    <% }) %>
                </div>
                
                <div class="cart-sidebar">
                    <div class="order-summary">
                        <h3><i class="fas fa-receipt"></i> Order Summary</h3>
                        
                        <div class="summary-row">
                            <span>Items (<span id="summaryItemCount"><%= cart.length %></span>):</span>
                            <span id="itemsTotal">‚Çπ<%= total.toFixed(2) %></span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Shipping:</span>
                            <span id="shippingCost">FREE</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Tax (GST 18%):</span>
                            <span id="taxAmount">‚Çπ<%= (total * 0.18).toFixed(2) %></span>
                        </div>
                        
                        <div class="summary-divider"></div>
                        
                        <div class="summary-total">
                            <span>Total:</span>
                            <span id="grandTotal">‚Çπ<%= (total * 1.18).toFixed(2) %></span>
                        </div>
                        
                        <div class="savings-info">
                            <i class="fas fa-tag"></i>
                            <span>You saved ‚Çπ<%= (total * 0.1).toFixed(2) %> on this order!</span>
                        </div>
                        
                        <form action="/user/checkout" method="POST" class="checkout-form" id="checkoutForm">
                            <div class="checkout-details">
                                <h3><i class="fas fa-shipping-fast"></i> Shipping Details</h3>
                                
                                <div class="form-group">
                                    <label for="shippingAddress">Address *</label>
                                    <textarea id="shippingAddress" name="shippingAddress" required 
                                              placeholder="Enter your complete address" rows="3"></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city">City *</label>
                                        <input type="text" id="city" name="city" required placeholder="Enter city">
                                    </div>
                                    <div class="form-group">
                                        <label for="postalCode">Postal Code *</label>
                                        <input type="text" id="postalCode" name="postalCode" required 
                                               placeholder="Enter postal code" pattern="[0-9]{6}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number *</label>
                                    <input type="tel" id="phone" name="phone" required 
                                           placeholder="Enter your phone number" pattern="[0-9]{10}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="paymentMethod">Payment Method</label>
                                    <select id="paymentMethod" name="paymentMethod">
                                        <option value="cod">Cash on Delivery (COD)</option>
                                        <option value="online">Online Payment (Coming Soon)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn primary large checkout-btn" id="checkoutBtn">
                                <i class="fas fa-lock"></i>
                                Place Order
                            </button>
                        </form>
                        
                        <div class="secure-checkout">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secure Checkout - Your data is protected</span>
                        </div>
                    </div>
                    
                    <div class="promo-section">
                        <h4><i class="fas fa-percent"></i> Have a Coupon?</h4>
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Enter coupon code">
                            <button type="button" class="btn secondary" onclick="applyCoupon()">
                                Apply
                            </button>
                        </div>
                    </div>
                    
                    <div class="recently-viewed">
                        <h4><i class="fas fa-clock"></i> Recently Viewed</h4>
                        <div class="recent-items">
                            <!-- Recently viewed items would go here -->
                            <p class="no-recent">No recently viewed items</p>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>LocalBuy</h4>
                <p>Your trusted local marketplace</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="/user/dashboard">Dashboard</a>
                <a href="/user/cart">Cart</a>
                <a href="/user/orders">Orders</a>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Contact Us</a>
                <a href="#">Shipping Info</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 LocalBuy. All rights reserved.</p>
        </div>
    </footer>

    <!-- Session Storage Cache Scripts -->
    <script src="/js/cache.js"></script>
    <!-- Cart sync manager disabled on cart page to prevent item restoration -->
    <!-- <script src="/js/cart-sync-manager.js"></script> -->
    <script src="/js/cart-manager.js"></script>
    <script src="/js/session-manager.js"></script>
    
    <!-- Local Storage Cache Scripts -->
    <script src="/js/local-cache.js"></script>
    <!-- Persistent cart disabled on cart page -->
    <!-- <script src="/js/persistent-cart.js"></script> -->
    <script src="/js/persistent-preferences.js"></script>
    
    <!-- Cache Integration disabled on cart page to prevent item restoration -->
    <!-- <script src="/js/cache-integration.js"></script> -->
    
    <script>
        // Define cart functions IMMEDIATELY and make them globally accessible
        window.toggleSelectAll = function toggleSelectAll() {
            console.log('üîÑ toggleSelectAll called');
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.item-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            window.updateSelection();
        }

        window.updateSelection = function updateSelection() {
            console.log('üìã updateSelection called');
            
            const checkboxes = document.querySelectorAll('.item-checkbox');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const removeButton = document.getElementById('removeSelected');
            
            console.log('‚úì Selected items count:', selectedCount);
            console.log('üîò Remove button found:', !!removeButton);
            
            if (removeButton) {
                if (selectedCount > 0) {
                    removeButton.style.display = 'inline-block';
                    removeButton.innerHTML = `<i class="fas fa-trash"></i> Remove Selected (${selectedCount})`;
                    console.log('‚úÖ Remove button shown with count:', selectedCount);
                } else {
                    removeButton.style.display = 'none';
                    console.log('‚ùå Remove button hidden');
                }
            } else {
                console.error('‚ùå Remove selected button not found in DOM');
            }
        }

        window.clearCart = function clearCart() {
            console.log('üßπ clearCart function called');
            
            const cartItems = document.querySelectorAll('.enhanced-cart-item');
            console.log('üì¶ Found cart items:', cartItems.length);
            
            if (cartItems.length === 0) {
                showToast('Cart is already empty', 'info');
                return;
            }
            
            console.log('‚ö†Ô∏è Showing confirmation dialog');
            if (confirm('Are you sure you want to clear your entire cart? This action cannot be undone.')) {
                console.log('‚úÖ User confirmed cart clearing');
                
                const clearButton = document.getElementById('clearCart');
                if (!clearButton) {
                    console.error('‚ùå Clear button not found');
                    showToast('Clear button not found', 'error');
                    return;
                }
                
                clearButton.disabled = true;
                clearButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
                
                console.log('üßπ Clearing cart with items:', cartItems.length);
                
                // Get all item IDs
                const itemIds = Array.from(cartItems)
                    .map(item => item.getAttribute('data-item-id'))
                    .filter(id => id);
                
                console.log('üîç Item IDs to remove:', itemIds);
                
                if (itemIds.length === 0) {
                    showToast('No valid items to remove', 'warning');
                    clearButton.disabled = false;
                    clearButton.innerHTML = '<i class="fas fa-trash"></i> Clear Cart';
                    return;
                }
                
                console.log('üóëÔ∏è Removing items:', itemIds);
                
                // Remove all items with better error handling
                Promise.all(itemIds.map(itemId => 
                    fetch(`/user/remove-from-cart/${itemId}`, { 
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                ))
                .then(responses => {
                    showToast('Cart cleared successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Clear cart error:', error);
                    clearButton.disabled = false;
                    clearButton.innerHTML = '<i class="fas fa-trash"></i> Clear Cart';
                    showToast('Failed to clear cart', 'error');
                });
            } else {
                console.log('‚ùå User cancelled cart clearing');
            }
        }

        window.removeItem = function removeItem(itemId) {
            console.log('üóëÔ∏è removeItem function called for item:', itemId);
            
            if (confirm('Are you sure you want to remove this item from your cart?')) {
                console.log('‚úÖ User confirmed item removal');
                
                const cartItem = document.querySelector(`[data-item-id="${itemId}"]`);
                if (!cartItem) {
                    console.error('‚ùå Cart item not found for ID:', itemId);
                    showToast('Item not found', 'error');
                    return;
                }
                
                const removeButton = cartItem.querySelector('.action-btn.remove');
                if (!removeButton) {
                    console.error('‚ùå Remove button not found for item:', itemId);
                    showToast('Remove button not found', 'error');
                    return;
                }
                
                // Show loading state
                cartItem.style.opacity = '0.5';
                removeButton.disabled = true;
                removeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                console.log('üóëÔ∏è Attempting to remove item:', itemId);
                
                // Send delete request to server
                fetch(`/user/remove-from-cart/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Remove item from DOM with animation
                        cartItem.style.transition = 'all 0.3s ease';
                        cartItem.style.transform = 'translateX(-100%)';
                        cartItem.style.opacity = '0';
                        
                        setTimeout(() => {
                            cartItem.remove();
                            updateCartTotals();
                            
                            // Update cache with new cart data
                            if (window.cache && data.cart) {
                                window.cache.set('server_cart', data.cart, 60);
                            }
                            
                            // Update cart manager
                            if (window.cartManager) {
                                window.cartManager.removeItem(itemId);
                            }
                            
                            showToast('Item removed from cart', 'success');
                            
                            // Check if cart is now empty
                            if (document.querySelectorAll('.enhanced-cart-item').length === 0) {
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            }
                        }, 300);
                    } else {
                        throw new Error(data.error || 'Failed to remove item');
                    }
                })
                .catch(error => {
                    console.error('Remove item error:', error);
                    
                    // Reset loading state
                    cartItem.style.opacity = '1';
                    removeButton.disabled = false;
                    removeButton.innerHTML = '<i class="fas fa-trash"></i>';
                    
                    showToast('Failed to remove item: ' + error.message, 'error');
                });
            } else {
                console.log('‚ùå User cancelled item removal');
            }
        }

        window.removeSelected = function removeSelected() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.item-checkbox:checked'));
            
            if (selectedCheckboxes.length === 0) {
                showToast('No items selected', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to remove ${selectedCheckboxes.length} selected item(s)?`)) {
                const removeButton = document.getElementById('removeSelected');
                removeButton.disabled = true;
                removeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
                
                const itemIds = selectedCheckboxes.map(checkbox => {
                    const cartItem = checkbox.closest('.enhanced-cart-item');
                    return cartItem.getAttribute('data-item-id');
                });
                
                Promise.all(itemIds.map(itemId => 
                    fetch(`/user/remove-from-cart/${itemId}`, { method: 'DELETE' })
                        .then(response => response.json())
                ))
                .then(responses => {
                    showToast(`${itemIds.length} item(s) removed successfully`, 'success');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Remove selected error:', error);
                    removeButton.disabled = false;
                    removeButton.innerHTML = '<i class="fas fa-trash"></i> Remove Selected';
                    showToast('Failed to remove selected items', 'error');
                });
            }
        }

        // Functions are already globally accessible via window.functionName definitions above

        // Check if cart was recently cleared and prevent restoration
        try {
            const cartClearedAt = localStorage.getItem('cart_cleared_at');
            if (cartClearedAt && (Date.now() - parseInt(cartClearedAt)) < 600000) { // 10 minutes
                console.log('üõë Cart was recently cleared, preventing any restoration');
                localStorage.removeItem('localBuy_cart');
                localStorage.removeItem('cart_data');
                sessionStorage.removeItem('cart_data');
            }
        } catch(e) {
            console.log('Clear flag check error:', e);
        }
        
        // Initialize Session Storage cache system
        window.cache = new BrowserCache();
        window.cartManager = new CartManager();
        window.userSessionManager = new UserSessionManager();
        
        // Initialize Local Storage cache system
        window.localCache = new LocalStorageCache();
        window.persistentCart = new PersistentCartManager(window.localCache);
        window.persistentPreferences = new PersistentPreferencesManager(window.localCache);
        
        // Apply persistent theme
        window.persistentPreferences.applyTheme();
        
        // Disable cache sync on cart page to prevent deleted items from reappearing
        console.log('‚ö†Ô∏è Cart sync disabled on cart page to prevent item restoration');
        
        // Clear any cached cart data that might restore deleted items
        try {
            if (window.location.pathname === '/user/cart') {
                localStorage.removeItem('localBuy_cart');
                sessionStorage.removeItem('cart_data');
                console.log('üóëÔ∏è Cleared cart cache to prevent item restoration');
            }
        } catch(e) {
            console.log('Cache clear error:', e);
        }
        
        console.log('‚úÖ Cart Page: Functions defined and Cache System Ready');

        let cartData = {
            items: [],
            total: <%= total || 0 %>
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing cart page...');
            
            try {
                initializeCart();
                console.log('‚úÖ Cart data initialized');
                
                setupEventListeners();
                console.log('‚úÖ Event listeners attached');
                
                syncWithCache();
                console.log('‚úÖ Cache synchronized');
                
                // Set user data if available
                <% if (user) { %>
                if (window.userSessionManager) {
                    window.userSessionManager.saveUserSession({
                        id: '<%= user.id %>',
                        username: '<%= user.name %>',
                        email: '<%= user.email %>',
                        role: '<%= user.role %>'
                    });
                    console.log('‚úÖ User session saved');
                }
                <% } %>
                
                // Validate cart state
                updateCartTotals();
                console.log('‚úÖ Cart totals updated');
                
                console.log('üéâ Cart page fully initialized');
            } catch (error) {
                console.error('‚ùå Cart initialization error:', error);
                showToast('Cart initialization error: ' + error.message, 'error');
            }
        });

        function initializeCart() {
            // Extract cart data from DOM
            const cartItems = document.querySelectorAll('.enhanced-cart-item');
            cartData.items = Array.from(cartItems).map(item => ({
                id: item.getAttribute('data-item-id'),
                price: parseFloat(item.getAttribute('data-price')),
                quantity: parseInt(item.querySelector('input[type="number"]').value),
                element: item
            }));
        }

        function syncWithCache() {
            // Sync current cart with cache
            const currentCart = {
                items: cartData.items.map(item => ({
                    id: item.id,
                    price: item.price,
                    quantity: item.quantity,
                    timestamp: Date.now()
                })),
                total: cartData.total,
                lastUpdated: Date.now()
            };
            
            window.cache.set('server_cart', currentCart, 60); // Cache for 1 hour
            
            // Sync with cart manager
            cartData.items.forEach(item => {
                window.cartManager.addItem({
                    id: item.id,
                    price: item.price,
                    quantity: item.quantity
                });
            });
        }

        function setupEventListeners() {
            console.log('üîß Setting up cart event listeners');
            
            // Prevent form submission on enter in quantity inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        updateQuantity(this.id.split('-')[1], 'set', this.value);
                    }
                });
            });
            
            // Clear cart button - use both onclick and addEventListener for reliability
            const clearCartBtn = document.getElementById('clearCart');
            if (clearCartBtn) {
                console.log('‚úÖ Clear cart button found, attaching event');
                clearCartBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üßπ Clear cart button clicked via addEventListener');
                    clearCart();
                });
            } else {
                console.warn('‚ö†Ô∏è Clear cart button not found');
            }
            
            // Remove selected button
            const removeSelectedBtn = document.getElementById('removeSelected');
            if (removeSelectedBtn) {
                console.log('‚úÖ Remove selected button found, attaching event');
                removeSelectedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üóëÔ∏è Remove selected button clicked via addEventListener');
                    removeSelected();
                });
            } else {
                console.warn('‚ö†Ô∏è Remove selected button not found');
            }
            
            // Select All checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function(e) {
                    console.log('üìã Select all checkbox changed:', this.checked);
                    toggleSelectAll();
                });
            }
            
            // Individual item checkboxes
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    console.log('‚òëÔ∏è Item checkbox changed');
                    window.updateSelection();
                });
            });
            
            // Attach remove item button events
            document.querySelectorAll('.action-btn.remove').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const itemId = this.closest('[data-item-id]').getAttribute('data-item-id');
                    if (itemId) {
                        console.log('üóëÔ∏è Remove item button clicked for item:', itemId);
                        removeItem(itemId);
                    }
                });
            });
            
            console.log('‚úÖ All cart event listeners attached');
        }

        // Functions are already globally accessible - no need for reassignment

        function updateQuantity(itemId, action, value) {
            const quantityInput = document.getElementById(`quantity-${itemId}`);
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = currentQuantity;

            switch(action) {
                case 'increase':
                    newQuantity = Math.min(currentQuantity + 1, 99);
                    break;
                case 'decrease':
                    newQuantity = Math.max(currentQuantity - 1, 1);
                    break;
                case 'set':
                    newQuantity = Math.max(1, Math.min(parseInt(value) || 1, 99));
                    break;
            }

            if (newQuantity !== currentQuantity) {
                quantityInput.value = newQuantity;
                
                // Update subtotal
                const cartItem = document.querySelector(`[data-item-id="${itemId}"]`);
                const price = parseFloat(cartItem.getAttribute('data-price'));
                const subtotal = (price * newQuantity).toFixed(2);
                document.getElementById(`subtotal-${itemId}`).textContent = `‚Çπ${subtotal}`;
                
                // Update cart totals
                updateCartTotals();
                
                // Show loading state
                quantityInput.disabled = true;
                
                // Send update to server
                fetch('/user/update-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${itemId}&quantity=${newQuantity}`
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Cart updated successfully', 'success');
                    } else {
                        throw new Error('Failed to update cart');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Failed to update cart', 'error');
                    // Revert quantity on error
                    quantityInput.value = currentQuantity;
                    updateCartTotals();
                })
                .finally(() => {
                    quantityInput.disabled = false;
                });
            }
        }



        function updateCartTotals() {
            let itemsTotal = 0;
            let itemCount = 0;
            
            document.querySelectorAll('.enhanced-cart-item').forEach(item => {
                const price = parseFloat(item.getAttribute('data-price'));
                const quantity = parseInt(item.querySelector('input[type="number"]').value);
                itemsTotal += price * quantity;
                itemCount++;
            });
            
            const tax = itemsTotal * 0.18;
            const grandTotal = itemsTotal + tax;
            
            document.getElementById('itemsTotal').textContent = `‚Çπ${itemsTotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `‚Çπ${tax.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('summaryItemCount').textContent = itemCount;
        }

        function applyCoupon() {
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                showToast('Please enter a coupon code', 'warning');
                return;
            }
            
            showToast('Checking coupon code...', 'info');
            
            // Mock coupon validation
            setTimeout(() => {
                if (promoCode.toLowerCase() === 'save10') {
                    showToast('Coupon applied! 10% discount added', 'success');
                } else {
                    showToast('Invalid coupon code', 'error');
                }
            }, 1000);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-triangle'
            }[type];
            
            toast.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 4000);
        }

        // Enhanced checkout handling
        function setupCheckoutForm() {
            const checkoutForm = document.getElementById('checkoutForm');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!checkoutForm) return;
            
            checkoutForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // Validate form
                    if (!validateCheckoutForm()) {
                        return;
                    }
                    
                    // Disable form during processing
                    checkoutBtn.disabled = true;
                    checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Order...';
                    checkoutBtn.classList.add('processing');
                    
                    // Get form data
                    const formData = new FormData(checkoutForm);
                    
                    // Submit checkout
                    const response = await fetch('/user/checkout', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Clear cart via sync manager
                        if (window.cartSyncManager) {
                            await window.cartSyncManager.clearCart();
                        }
                        
                        showToast('Order placed successfully!', 'success');
                        
                        // Redirect after delay
                        setTimeout(() => {
                            window.location.href = result.redirectUrl || '/user/orders';
                        }, 1500);
                    } else {
                        throw new Error(result.error || 'Checkout failed');
                    }
                    
                } catch (error) {
                    console.error('Checkout error:', error);
                    showToast('Checkout failed: ' + error.message, 'error');
                    
                    // Re-enable form
                    checkoutBtn.disabled = false;
                    checkoutBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order';
                    checkoutBtn.classList.remove('processing');
                }
            });
        }
        
        function validateCheckoutForm() {
            const requiredFields = ['shippingAddress', 'city', 'postalCode', 'phone'];
            let isValid = true;
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const value = field.value.trim();
                
                if (!value) {
                    field.style.borderColor = var(--danger-color);
                    isValid = false;
                    showToast(`Please fill in ${fieldName.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'warning');
                } else {
                    field.style.borderColor = '#e0e0e0';
                }
            });
            
            // Validate postal code format
            const postalCode = document.getElementById('postalCode').value.trim();
            if (postalCode && !/^\d{6}$/.test(postalCode)) {
                document.getElementById('postalCode').style.borderColor = var(--danger-color);
                showToast('Please enter a valid 6-digit postal code', 'warning');
                isValid = false;
            }
            
            // Validate phone number format
            const phone = document.getElementById('phone').value.trim();
            if (phone && !/^\d{10}$/.test(phone)) {
                document.getElementById('phone').style.borderColor = var(--danger-color);
                showToast('Please enter a valid 10-digit phone number', 'warning');
                isValid = false;
            }
            
            return isValid;
        }

        // Initialize checkout form when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupCheckoutForm();
        });
    </script>
    <script src="/js/cart-counter.js"></script>
</body>
</html>