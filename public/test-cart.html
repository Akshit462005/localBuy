<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalBuy Cart Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>LocalBuy Cart & LocalStorage Test</h1>
    
    <div>
        <button onclick="initializeSystem()">1. Initialize System</button>
        <button onclick="addTestItem()">2. Add Test Item</button>
        <button onclick="showCart()">3. Show Cart</button>
        <button onclick="showLocalStorage()">4. Show LocalStorage</button>
        <button onclick="clearCart()">5. Clear Cart</button>
    </div>
    
    <div id="output" class="output"></div>
    
    <!-- Include the necessary scripts -->
    <script src="/js/local-cache.js"></script>
    <script src="/js/persistent-cart.js"></script>
    <script src="/js/persistent-preferences.js"></script>
    
    <script>
        let localCache, persistentCart, persistentPrefs;
        
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }
        
        function initializeSystem() {
            try {
                log('=== Initializing LocalBuy System ===');
                
                // Initialize LocalStorage cache
                localCache = new LocalStorageCache();
                log('✅ LocalStorageCache initialized');
                
                // Initialize persistent cart
                persistentCart = new PersistentCartManager(localCache);
                log('✅ PersistentCartManager initialized');
                
                // Initialize persistent preferences
                persistentPrefs = new PersistentPreferencesManager(localCache);
                log('✅ PersistentPreferencesManager initialized');
                
                // Store as global for easy access
                window.localCache = localCache;
                window.persistentCart = persistentCart;
                window.persistentPrefs = persistentPrefs;
                
            } catch (e) {
                log('❌ Error initializing: ' + e.message);
            }
        }
        
        function addTestItem() {
            if (!persistentCart) {
                log('❌ Please initialize system first');
                return;
            }
            
            try {
                const testProduct = {
                    id: Date.now(),
                    name: 'Test Product ' + Math.floor(Math.random() * 1000),
                    price: 19.99,
                    quantity: 1,
                    description: 'This is a test product',
                    category: 'Electronics'
                };
                
                log('Adding test product: ' + testProduct.name);
                const result = persistentCart.addItem(testProduct);
                
                if (result) {
                    log('✅ Item added successfully');
                } else {
                    log('❌ Failed to add item');
                }
                
            } catch (e) {
                log('❌ Error adding item: ' + e.message);
            }
        }
        
        function showCart() {
            if (!persistentCart) {
                log('❌ Please initialize system first');
                return;
            }
            
            try {
                const items = persistentCart.getItems();
                const summary = persistentCart.getSummary();
                
                log('=== Cart Contents ===');
                log('Item count: ' + items.length);
                log('Total: $' + summary.total);
                log('Items:');
                
                items.forEach((item, index) => {
                    log(`  ${index + 1}. ${item.name} - $${item.price} x ${item.quantity}`);
                });
                
            } catch (e) {
                log('❌ Error showing cart: ' + e.message);
            }
        }
        
        function showLocalStorage() {
            log('=== LocalStorage Contents ===');
            
            if (localStorage.length === 0) {
                log('No items in LocalStorage');
                return;
            }
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                if (key.startsWith('localbuy_local_')) {
                    const value = localStorage.getItem(key);
                    log(`${key}:`);
                    
                    try {
                        const parsed = JSON.parse(value);
                        log(JSON.stringify(parsed, null, 2));
                    } catch {
                        log(value);
                    }
                    log('---');
                }
            }
        }
        
        function clearCart() {
            if (!persistentCart) {
                log('❌ Please initialize system first');
                return;
            }
            
            try {
                persistentCart.clearCart();
                log('✅ Cart cleared');
            } catch (e) {
                log('❌ Error clearing cart: ' + e.message);
            }
        }
        
        // Auto-initialize on page load
        window.onload = function() {
            log('Cart Test Page Ready');
            log('Click "Initialize System" to begin');
        };
    </script>
</body>
</html>